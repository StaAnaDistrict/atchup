<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SACES School Form 10 Generator</title>
  <link rel="stylesheet" href="styles.css">  
  
    <!-- Existing meta tags and title -->
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://atchup.netlify.app">
    <meta property="og:title" content="SACES School Form 10 Generator">
    <meta property="og:description" content="Sta. Ana Central Elementary School Davao City's School Form 10 Generator which was designed by Sir Wedzmer B. Munjilul. Access to the web application is limited only for authorized school personnel.">
    <meta property="og:image" content="https://i.imgur.com/GqC0tCW.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://atchup.netlify.app">
    <meta property="twitter:title" content="SACES School Form 10 Generator">
    <meta property="twitter:description" content="Sta. Ana Central Elementary School Davao City's School Form 10 Generator which was designed by Sir Wedzmer B. Munjilul. Access to the web application is limited only for authorized school personnel.">
    <meta property="twitter:image" content="https://i.imgur.com/GqC0tCW.png">

</head>
<body>
<script>
  window.addEventListener('beforeunload', function (e) {
    // Cancel the event
    e.preventDefault();
    // Chrome requires returnValue to be set
    e.returnValue = '';

    // Perform logout
    localStorage.removeItem('loggedInUser');
    localStorage.removeItem('userStatus');

    // Note: You can't make asynchronous calls here, so any server-side logout
    // would need to be handled differently
  });
</script>  
  <div id="userInfo" class="user-info">
    <span id="loggedInUser"></span>
    <button id="logoutBtn" class="logout-btn">Log out</button>
  </div>

  <section class="parallax">
    <img src="https://i.imgur.com/kCPCM4U.png" id="layer1">
    <img src="https://i.imgur.com/Pg79VtJ.png" id="layer2">
    <img src="https://i.imgur.com/WV8r5qC.png" id="layer3">
    <img src="https://i.imgur.com/obs5gw7.png" id="layer4">
    <img src="https://i.imgur.com/7na1drq.png" id="layer5">
    <img src="https://i.imgur.com/IvJiNr2.png" id="layer6">
    <img src="https://i.imgur.com/DntWC3w.png" id="layer7">
    <img src="https://i.imgur.com/8ykQDcs.png" id="layer8">
    <img src="https://i.imgur.com/dc4bOvA.png" id="layer9">
    <img src="https://i.imgur.com/8F6HXX8.png" id="layer10">
    <img src="https://i.imgur.com/S90ZqnH.png" id="layer11">
    <img src="https://i.imgur.com/qm0NAeH.png" id="layer12">
    <img src="https://i.imgur.com/mbU7IMP.png" id="layer13">
    <img src="https://i.imgur.com/h6eyM7L.png" id="layer14">
    
</section>
<div id="status"></div>
<div class="search-container">
  <div class="grid"></div>
  <div id="poda">
    <div class="glow"></div>
    <div class="darkBorderBg"></div>
    <div class="darkBorderBg"></div>
    <div class="darkBorderBg"></div>
    <div class="white"></div>
    <div class="border"></div>
    <div id="main">
      <input placeholder="Search..." type="text" name="text" class="input" id="searchInput" />
      <div id="input-mask"></div>
      <div id="pink-mask"></div>
      <div class="filterBorder"></div>
      <div id="filter-icon">
        <svg preserveAspectRatio="none" height="27" width="27" viewBox="4.8 4.56 14.832 15.408" fill="none">
          <path d="M8.16 6.65002H15.83C16.47 6.65002 16.99 7.17002 16.99 7.81002V9.09002C16.99 9.56002 16.7 10.14 16.41 10.43L13.91 12.64C13.56 12.93 13.33 13.51 13.33 13.98V16.48C13.33 16.83 13.1 17.29 12.81 17.47L12 17.98C11.24 18.45 10.2 17.92 10.2 16.99V13.91C10.2 13.5 9.97 12.98 9.73 12.69L7.52 10.36C7.23 10.08 7 9.55002 7 9.20002V7.87002C7 7.17002 7.52 6.65002 8.16 6.65002Z" stroke="#d6d6e6" stroke-width="1" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path>
        </svg>
      </div>
      <div id="search-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" height="24" fill="none" class="feather feather-search">
          <circle stroke="url(#search)" r="8" cy="11" cx="11"></circle>
          <line stroke="url(#searchl)" y2="16.65" y1="22" x2="16.65" x1="22"></line>
          <defs>
            <linearGradient gradientTransform="rotate(50)" id="search">
              <stop stop-color="#f8e7f8" offset="0%"></stop>
              <stop stop-color="#b6a9b7" offset="50%"></stop>
            </linearGradient>
            <linearGradient id="searchl">
              <stop stop-color="#b6a9b7" offset="0%"></stop>
              <stop stop-color="#837484" offset="50%"></stop>
            </linearGradient>
          </defs>
        </svg>
      </div>
    </div>
  </div>
</div>
<div id="results"></div>

<div id="notification" class="notification"></div>
<label class="material-checkbox">
  <input type="checkbox" id="privacyCheckbox">
  <span class="checkmark"></span>
  By running a search, you agree to the terms and conditions of the Data Privacy Act of 2012.
</label>
  </div>
  <footer>
    <p>&copy; 2023 SACES School Form 10 Generator by Sir Wedzmer Munjilul. All rights reserved.</p>
  </footer>

  <script>
    function checkLoginStatus() {
    const loggedInUser = localStorage.getItem('loggedInUser');
    const userStatus = localStorage.getItem('userStatus');
    const userInfoElement = document.getElementById('userInfo');
    const loggedInUserElement = document.getElementById('loggedInUser');
    
    if (loggedInUser && userStatus === 'APPROVED') {
        loggedInUserElement.textContent = `Logged in as: ${loggedInUser}`;
        userInfoElement.style.display = 'flex';
    } else {
        userInfoElement.style.display = 'none';
        localStorage.removeItem('loggedInUser');
        localStorage.removeItem('userStatus');
        window.location.href = 'signin.html?message=Please log in to access this page.';
    }
    }
  
    document.getElementById('logoutBtn').addEventListener('click', function() {
    localStorage.removeItem('loggedInUser');
    localStorage.removeItem('userStatus');
    window.location.href = 'signin.html';
});
  
    // Call this function when the page loads
    window.addEventListener('DOMContentLoaded', checkLoginStatus);
  </script>
  
  <script>
    let layer1 = document.getElementById('layer1');
    let layer2 = document.getElementById('layer2');
    let layer3 = document.getElementById('layer3');
    let layer4 = document.getElementById('layer4');
    let layer5 = document.getElementById('layer5');
    let layer6 = document.getElementById('layer6');
    let layer7 = document.getElementById('layer7');
    let layer8 = document.getElementById('layer8');
    let layer9 = document.getElementById('layer9');
    let layer10 = document.getElementById('layer10');
    let layer11 = document.getElementById('layer11');
    let layer12 = document.getElementById('layer12');
    let layer13 = document.getElementById('layer13');
    let layer14 = document.getElementById('layer14');
    let text = document.getElementById('text');
    
    
    // Set initial styles for all layers
    for (let i = 1; i <= 14; i++) {
        let layer = document.getElementById(`layer${i}`);
        if (layer) {
            layer.style.transition = 'opacity 0.5s ease, left 0.5s ease';
        }
    }
    
    // Set initial styles for all layers
    for (let i = 1; i <= 14; i++) {
        let layer = document.getElementById(`layer${i}`);
        if (layer) {
            layer.style.transition = 'opacity 0.5s ease-out, left 0.5s cubic-bezier(0.25, 0.1, 0.25, 1)';
        }
    }
    
    // Set initial styles for layer14
    layer14.style.opacity = '0';
    
    window.addEventListener('scroll', () => {
        let value = window.scrollY;
        let windowWidth = window.innerWidth;
        
        for (let i = 2; i <= 14; i++) {
            let layer = document.getElementById(`layer${i}`);
            if (layer) {
                let moveDistance = value * 10;
                let opacity = 1;

                if (i <= 10) {
                    layer.style.left = `-${moveDistance}px`;
                    opacity = Math.max(0, 1 - (moveDistance / windowWidth));
                } else if (i <= 13) {
                    layer.style.left = `${moveDistance}px`;
                    opacity = Math.max(0, 1 - (moveDistance / windowWidth));
                } else if (i === 14) {
                    // Gradually show layer14 as user scrolls
                    opacity = Math.min(value / 100, 1);  // Adjust 100 to control fade-in speed
                }

                layer.style.opacity = opacity;
            }
        }

        // Optional: hide the original text as layer14 appears
        if (text) {
            let opacity = Math.max(0, 1 - value / 100);
            text.style.opacity = opacity;
        }
    });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    checkDatabaseStatus();
    
    const searchInput = document.getElementById('searchInput');
    const privacyCheckbox = document.getElementById('privacyCheckbox');
    const notification = document.getElementById('notification');

    function showNotification(message) {
      notification.textContent = message;
      notification.style.display = 'block';
      setTimeout(() => {
        notification.style.display = 'none';
      }, 3000); // Hide notification after 3 seconds
    }

    function checkPrivacyAgreement() {
      if (!privacyCheckbox.checked) {
        showNotification("Search functions will only run if you check the terms and conditions below.");
        return false;
      }
      return true;
    }

    searchInput.addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        if (checkPrivacyAgreement()) {
          fetchStudentData();
        }
      }
    });
  });

  async function checkDatabaseStatus() {
      const apiUrl = 'https://sheets.googleapis.com/v4/spreadsheets/1mDQKmYmwCZrtsSg6FE1ascQO5toMKGiwj5xo7-bRXsk/values/%27Learners%27%20Profile%27!A1?key=AIzaSyAC2cZQFW6J70ia1n5yLTGoxIVvu8FH17s';
      const statusElement = document.getElementById('status');

      try {
        const response = await fetch(apiUrl);
        if (response.ok) {
          statusElement.textContent = 'Database is active, input name below.';
          statusElement.classList.add('active');
        } else {
          throw new Error('API response was not ok.');
        }
      } catch (error) {
        console.error('Error checking database status:', error);
        statusElement.textContent = 'Database is currently offline';
        statusElement.classList.add('inactive');
      }
    }

    async function fetchStudentData() {
      const searchInput = document.getElementById('searchInput').value;
      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = 'Fetching data...';

      try {
        // Fetch data from both sources
        const [profileResponse, scholasticResponse] = await Promise.all([
          fetch(`https://sheets.googleapis.com/v4/spreadsheets/1mDQKmYmwCZrtsSg6FE1ascQO5toMKGiwj5xo7-bRXsk/values/'Learners' Profile'!A4:DH2506?key=AIzaSyAC2cZQFW6J70ia1n5yLTGoxIVvu8FH17s`),
          fetch(`https://sheets.googleapis.com/v4/spreadsheets/1mDQKmYmwCZrtsSg6FE1ascQO5toMKGiwj5xo7-bRXsk/values/'Learners'' Scholastic Record'!A4:AUY?key=AIzaSyAC2cZQFW6J70ia1n5yLTGoxIVvu8FH17s`)
        ]);

        const profileData = await profileResponse.json();
        const scholasticData = await scholasticResponse.json();

        // Filter profile data
        const filteredProfileData = profileData.values.filter(row => row[0].toLowerCase().includes(searchInput.toLowerCase()));
        console.log("Filtered profile data:", filteredProfileData);

        // Filter scholastic data
        const filteredScholasticData = scholasticData.values.filter(row => row[0].toLowerCase().includes(searchInput.toLowerCase()));
        console.log("Filtered scholastic data:", filteredScholasticData);

        if (filteredProfileData.length > 0 && filteredScholasticData.length > 0) {
          const processedProfileData = processData(filteredProfileData[0]);
          const processedScholasticData = processData(filteredScholasticData[0]);
          openResultsWindow(processedProfileData, processedScholasticData, searchInput);
          
          resultsDiv.innerHTML = 'Data fetched successfully. Check the new window for results.';
        } else {
          resultsDiv.innerHTML = 'No matching records found. Please try again.';
        }
      } catch (error) {
        console.error("Error fetching or processing data:", error);
        resultsDiv.innerHTML = 'An error occurred while fetching data. Please try again later.';
      }
    }

    function isEmpty(value) {
      if (typeof value === 'undefined' || value === null) return true;
      const stringValue = String(value).trim().toUpperCase();
      return stringValue === '' || stringValue === '#NA' || stringValue === 'NA' || stringValue === '#N/A' || stringValue === 'N/A' || stringValue === 'ERROR';
    }

    function processData(data) {
      return data.map(value => isEmpty(value) ? '' : value);
    }

    function displayValue(value, maxWidth, isSchoolYear = false) {
      if (isEmpty(value)) {
        return `<span class="empty-value" style="display:inline-block; width:${maxWidth}px; border-bottom:1px solid black;">&nbsp;</span>`;
      }
      const style = isSchoolYear ? 'white-space: nowrap; overflow: visible;' : '';
      return `<span class="value" style="max-width:${maxWidth}px; ${style}">${value}</span>`;
    }

    function displaySignature(value, maxWidth) {
      console.log("Signature value:", value); // Debugging line
      if (isEmpty(value)) {
        return `<span class="empty-signature" style="display:inline-block; width:${maxWidth}px; border-bottom:1px solid black;">&nbsp;</span>`;
      }
      // Check if the value is a valid URL
      if (typeof value === 'string' && value.trim().toLowerCase().startsWith('http')) {
        return `<img src="${value}" alt="Signature" class="signature-image" style="max-width:${maxWidth}px;">`;
      }
      // If it's not a URL, display it as text
      return `<span class="value" style="max-width:${maxWidth}px;">${value}</span>`;
    }

    function openResultsWindow(profileData, scholasticData, searchName) {
      const resultsWindow = window.open('', `SF-10 of ${searchName}`, 'width=1000,height=800');
      console.log("Processed profile data array:", profileData);
      console.log("Processed scholastic data array:", scholasticData);

      resultsWindow.document.write(`
        <html>
          <head>
            <title>SF-10 of ${searchName} | Sta. Ana Central Elementary School</title>
            <style>
              body {
                font-family: Arial, sans-serif;
                padding: 15px;
                margin: 0;
                font-size: 11px;
                background-image: linear-gradient(to right, #0f0f10 1px, transparent 1px),
                linear-gradient(to bottom, #0f0f10 1px, transparent 1px);  
              }
              .sf10-label { font-size: 10px; margin-bottom: 5px; }  
              .header { display: flex; align-items: flex-start; }
              .logo-left { width: 90px; height: 90px; margin-right: 10px; }
              .header-text { flex-grow: 1; text-align: center; display: flex; flex-direction: column; justify-content: flex-start; }
              .header-text h3 { font-size: 11px; margin: 0; font-weight: normal; }  
              .header-text h2 { font-size: 12px; margin: 0; font-weight: normal; }  
              .header-text h1 { font-size: 16px; margin: 0; font-weight: bold; }  
              .subtitle { font-style: italic; font-size: 11px; margin: 0; font-weight: normal; }  /* Reduced from 12px to 11px */
              .logo-right { width: 180px; height: 90px; }
              .section-header {
                background-color: #A9A9A9;
                border: 1px solid black;
                padding: 5px;
                text-align: center;
                font-weight: bold;
                margin-top: 10px;
                margin-bottom: 2px;
                font-size: 10px;  /* Reduced from 11px to 10px */
              }
              .info-row { display: flex; justify-content: space-between; margin-top: 5px; }
              .info-item { display: flex; align-items: baseline; }
              .info-label { margin-right: 5px; }
              .info-value { border-bottom: 1px solid black; min-width: 100px; display: inline-block; margin-right: 20px; padding-bottom: 2px; }
              .info-value.empty { min-width: 50px; }
              .spacer { height: 5px; }
              .eligibility-section {
                margin-top: 10px;
                border: 1px solid black;
                padding: 10px;
                font-size: 10px;
              }
              .eligibility-row {
                display: flex;
                align-items: flex-end;
                margin-top: 5px;
                flex-wrap: nowrap;
                white-space: nowrap;
              }
              .eligibility-item {
                display: flex;
                align-items: flex-end;
                margin-right: 15px;
              }
              .eligibility-label {
                margin-right: 5px;
                flex-shrink: 0;
              }
              .info-value {
                border-bottom: 1px solid black;
                display: inline-block;
                padding: 0 2px;
              }
              .school-name-value {
                min-width: 150px;
                max-width: 300px;
                flex-grow: 1;
              }
              .school-id-value {
                width: 70px; /* Adjusted to fit 8 characters comfortably */
              }
              .school-address-value {
                min-width: 150px;
                max-width: 300px;
                flex-grow: 1;
              }
              .eligibility-label.italic {
                font-style: italic;
              }
              .checkbox-group {
                display: inline-flex;
                align-items: center;
                margin-right: 20px;
              }
              .checkbox {
                width: 8px;  /* Reduced from 9px to 8px */
                height: 8px;  /* Reduced from 9px to 8px */
                border: 1px solid black;
                display: inline-block;
                margin-right: 5px;
              }
              .checkbox.checked::after {
                content: '✓';
                display: block;
                text-align: center;
                line-height: 8px;  /* Reduced from 9px to 8px */
                font-size: 6px;  /* Reduced from 7px to 6px */
              }
              .other-credential-section {
                margin-top: 10px;
                font-size: 8px;  /* Reduced from 9px to 8px */
              }
              .other-credential-row {
                display: flex;
                align-items: flex-end;  /* Changed from center to flex-end */
                margin-top: 5px;
              }
              .indent {
                margin-left: 30px;
              }
              .space-after {
                margin-right: 20px;
              }
              .underline {
                border-bottom: 1px solid black;
                display: inline-block;
                min-width: 100px;
                padding-bottom: 2px;  /* Added padding to push content above the underline */
              }
              .info-value, .underline {
                font-size: 10px;  /* Explicitly set font size for fetched data results */
              }
              @media print {
                .section-header {
                  -webkit-print-color-adjust: exact;
                  print-color-adjust: exact;
                  background-color: #A9A9A9 !important;
                }
                body {
                  -webkit-print-color-adjust: exact;
                  print-color-adjust: exact;
                }
              }
              .scholastic-record {
                display: flex;
                justify-content: space-between;
                margin-top: 10px;
              }
              .box {
                border: 2px solid black;
                border-collapse: collapse;
                width: 48%; /* This ensures each box takes up slightly less than half the width */
                height: 400px; /* Set a fixed height - adjust this value as needed */
                table-layout: fixed; /* This ensures the table doesn't expand beyond its set width */
              }
              .box td {
                border: 1px solid black;
                padding: 2px;
                font-size: 8px;
                height: 12px; /* Fixed height for each row */
                overflow: hidden; /* This will prevent content from expanding the cell */
                white-space: nowrap; /* Prevents text from wrapping */
                text-overflow: ellipsis; /* Adds an ellipsis for overflowing text */
              }
              /* Remove inner borders for rows 1-4 */
              .box tr:nth-child(-n+4) td {
                border: none;
              }
              /* Thick bottom border for row 4 */
              .box tr:nth-child(4) td {
                border-bottom: 2px solid black;
              }
              /* Maintain top border for first row */
              .box tr:first-child td {
                border-top: 2px solid black;
              }
              /* Maintain left border for first column in rows 1-4 */
              .box tr:nth-child(-n+4) td:first-child {
                border-left: 2px solid black;
              }
              /* Maintain right border for last column in rows 1-4 */
              .box tr:nth-child(-n+4) td:last-child {
                border-right: 2px solid black;
              }
              /* Styles for school label */
              .box .school-label {
                text-align: left;
                padding-left: 0;
                font-weight: normal;
              }
              /* Styles for school ID label */
              .box .school-id-label {
                text-align: right;
                padding-right: 0;
                font-weight: normal;
              }
              /* Styles for school name and ID */
              .box .school-name, .box .school-id {
                text-align: left;
                font-style: normal;
                text-decoration: underline;
              }
              .box .school-id-container {
                text-align: right;
              }
              /* Styles for labels */
              .box .label {
                font-weight: normal;
                padding-right: 2px;
              }
              /* Styles for values */
              .box .value {
                text-decoration: underline;
                word-break: break-all;
                font-size: 7px;
              }
              .box .region-container {
                text-align: right;
              }
              .box .school-year-container {
                text-align: right;
              }
              .signature-image {
                max-width: 100%;
                max-height: 15px;
                object-fit: contain;
                vertical-align: middle;
              }
              .empty-value, .value {
                display: inline-block;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                vertical-align: bottom;
              }
              .empty-value {
                border-bottom: 1px solid black;
                height: 1.2em; /* Adjust as needed */
              }
              .value {
                border-bottom: none;
              }
              .empty-signature {
                display: inline-block;
                border-bottom: 1px solid black;
                height: 15px;
              }
              .signature-image {
                max-height: 15px;
                width: auto;
                vertical-align: bottom;
              }
              .school-year-container {
                width: 100%;
                word-break: break-all;
              }
              @media print {
                .value, .empty-value {
                  overflow: visible !important;
                  white-space: normal !important;
                  word-break: break-word !important;
                  page-break-inside: avoid !important;
                }
              }
              .school-year-value {
                display: inline-block;
                max-width: 100%;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
              }
              @media print {
                .value, .empty-value, .school-year-value {
                  overflow: visible !important;
                  white-space: normal !important;
                  word-break: break-word !important;
                }
              }
              .box-row {
                display: flex;
                flex-wrap: nowrap;
                width: 100%;
              }
              .box-cell {
                flex: 1;
                min-width: 0;
              }
              .school-year-value, .value, .empty-value {
                display: inline-block;
                max-width: 100%;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
              }
              @media print {
                .school-year-value, .value, .empty-value {
                  overflow: visible !important;
                  white-space: normal !important;
                  word-break: break-word !important;
                }
                .box-row {
                  page-break-inside: avoid;
                }
              }
              .school-year-container {
                white-space: nowrap;
                overflow: visible;
              }
              @media print {
                .value, .empty-value {
                  overflow: visible !important;
                  white-space: normal !important;
                  word-break: break-word !important;
                }
              }
              @media print {
                .box tr {
                  page-break-inside: avoid;
                }
                .value, .empty-value {
                  overflow: hidden !important;
                  text-overflow: ellipsis !important;
                  white-space: nowrap !important;
                  max-width: 100% !important;
                }
              }
              .grades-header-row td {
                height: 10px;
                font-weight: bold;
                text-align: center;
                vertical-align: middle;
                border: 1px solid black; /* Ensure borders are visible */
              }
              .grades-area-label,
              .grades-quarter-label,
              .grades-final-label,
              .grades-remarks-label,
              .grades-quarter-num {
                background-color: transparent; /* Remove any background color */
              }
              .grades-final-label,
              .grades-remarks-label {
                white-space: pre-line; /* This allows for line breaks in the content */
              }
              .grades-data-row td {
                border: 1px solid black;
                height: 12px; /* Adjust this value as needed */
              }
              .subject-cell {
                text-align: left;
                padding-left: 5px;
              }
              .grade-cell, .final-grade-cell {
                text-align: center;
              }
              .remarks-cell {
                text-align: center;
              }
              .subject-cell-bold {
                font-weight: bold;
              }
              .subject-cell-italic {
                font-style: italic;
              }
              .remedial-tables {
                display: flex;
                justify-content: space-between;
                margin-top: 10px; /* This creates the half-row distance */
              }

              .remedial-table {
                border-collapse: collapse;
                width: 48%;
                border: 2px solid black;
              }

              .remedial-table td {
                border: 1px solid black;
                padding: 2px;
                font-size: 8px;
                height: 15px;
                vertical-align: middle;
              }

              .remedial-table tr:first-child td {
                border: none;
                border-bottom: 1px solid black; /* Changed from 2px to 1px */
              }

              .remedial-table tr:first-child td:last-child {
                border-right: 2px solid black;
              }

              .remedial-header {
                font-weight: bold;
                text-align: left;
                padding-left: 5px;
              }

              .remedial-subheader {
                font-weight: bold;
                text-align: center;
                vertical-align: middle;
              }

              /* Remove inner vertical borders for merged cells in rows 2 and 3 */
              .remedial-table tr:nth-child(2) td,
              .remedial-table tr:nth-child(3) td {
                border-top: none;
                border-bottom: none;
              }

              .remedial-table tr:nth-child(2) td:not(:last-child),
              .remedial-table tr:nth-child(3) td:not(:last-child) {
                border-right: none;
              }

              .remedial-table tr:nth-child(2) td:first-child,
              .remedial-table tr:nth-child(3) td:first-child {
                border-left: 2px solid black;
              }

              .remedial-table tr:nth-child(2) td:last-child,
              .remedial-table tr:nth-child(3) td:last-child {
                border-right: 2px solid black;
              }

              .remedial-table tr:nth-child(4) td,
              .remedial-table tr:nth-child(5) td {
                border: 1px solid black;
              }

              .scholastic-record + .scholastic-record {
                margin-top: 2px; /* Adjust this value as needed */
              }

              .remedial-tables-34 {
                display: flex;
                justify-content: space-between;
                margin-top: 10px; /* Adjust this value to create the desired gap */
                margin-bottom: 35px;
              }

              .remedial-tables-6 {
                display: flex;
                justify-content: space-between;
                margin-top: 10px; /* Adjust this value to create the desired gap */
                margin-bottom: 10px;
              }

              .remedial-table {
                border-collapse: collapse;
                width: 48%;
              }

              .rt-3, .rt-4 {
                border: 2px solid black;
              }

              .rt-3 td, .rt-4 td {
                border: 1px solid black;
                height: 20px; /* Adjust this value as needed */
                width: 5.26%; /* 100% / 19 columns */
              }

              @media print {
                .remedial-tables-34 {
                  page-break-inside: avoid;
                }
              }

              .remedial-header {
                font-weight: bold;
                text-align: left;
                padding-left: 5px;
              }

              .rt-3, .rt-4 {
                border: 2px solid black;
                width: 48%;
              }

              .rt-3 td, .rt-4 td {
                border: 1px solid black;
                height: 20px;
                font-size: 8px;
                vertical-align: middle;
              }

              .rt-3 tr:first-child td, .rt-4 tr:first-child td {
                border-top: none;
              }

              .rt-3 tr:first-child td:first-child, .rt-4 tr:first-child td:first-child {
                border-left: none;
              }

              .rt-3 tr:first-child td:last-child, .rt-4 tr:first-child td:last-child {
                border-right: none;
              }

              .page-info {
              display: flex;
              justify-content: space-between;
              margin-top: 30px;
              margin-bottom: 0px;
              }

              .page-info-2 {
              display: flex;
              justify-content: space-between;
              margin-top: 0px;
              margin-bottom: 0px;
              padding-top: 15px;
              }

              .page-info-a {
              display: flex;
              justify-content: space-between;
              margin-top: 10px;
              margin-bottom: 0px;
              height: 10px;
              }

              .page-end {
              display: flex;
              justify-content: space-between;
              margin-top: 5px;
              margin-bottom: 0px;
              }

              .section-header-2 {
                background-color: #A9A9A9;
                border: 1px solid black;
                padding: 5px;
                text-align: center;
                font-weight: bold;
                margin-top: 5px;
                margin-bottom: 2px;
                font-size: 10px;  /* Reduced from 11px to 10px */

              }

            /* ... (existing styles) ... */
            .remedial-tables-5 {
            margin-top: 10px; /* Add space between Box 5 and its remedial table */
            }

            .remedial-tables-6 {
              margin-top: 10px;
            }

            .remedial-tables-7 {
              display: flex;
              justify-content: space-between;
              margin-top: 10px;
              margin-bottom: 10px;
            }

            .remedial-tables-8 {
              margin-top: 10px;
            }

            .certification-header {
              display: flex;
              font-weight: bold;
              margin-bottom: 5px;
            }

            .certification-header-transfer {
              display: flex;
              font-weight: bold;
              margin-bottom: 2px;
              margin-top: 5px;
            }

            .certification-tables {
              width: 100%;
              border-collapse: collapse;
              border: 1px solid black;
            }

            .certification-tables td {
              height: auto;
              border: none;
              padding: 0px 5px;
              line-height: 1;
            }

            .certification-tables td.certification-header {
              font-weight: bold;
              font-size: 12px;
              text-align: center;
              vertical-align: middle;
              background-color: #f0f0f0;
              height: 12px;
            }

            .certification-tables td.certification-header span {
              display: block;
              width: 100%;
              text-align: center;
            }

            .certification-content {
              text-align: justify;
              padding-left: 35px;
              padding-right: 20px;
              font-size: 12px;
              height: 25px;
            }

            .certification-content-2 {
              text-align: left ;
              padding-left: 35px;
              padding-right: 10px;
              font-size: 11px;
            }

            .certification-content-2::before {
              content: '';
              display: inline-block;
              width: 40px;
            }

            .certification-content::before {
              content: '';
              display: inline-block;
              width: 40px;
            }

            #certification-row-6 td,
            #certification-row-7 td {
              font-size: 11px;
              text-align: center;
              height: auto; /* Change from 10px to auto */
              padding: 0; /* Remove padding */
              margin: 0;
            }

            .certification-row-3 {
              margin-bottom: 10px; /* Adjust this value as needed */
              
            }

            /* If the above doesn't work due to table structure, try this instead: */
            .certification-row-3 td {
              padding-bottom: 25px; /* Adjust this value as needed */
              padding-top: 7px;
            }


            </style>
          </head>
          <body>
            <div class="sf10-label">SF10-ES</div>
            <div class="header">
              <img src="https://i.imgur.com/fqVPSHw.png" alt="Left Logo" class="logo-left">
              <div class="header-text">
                <h3>Republic of the Philippines</h3>
                <h2>Department of Education</h2>
                <h1>Learner Permanent Record for Elementary School (SF10-ES)</h1>
                <div class="subtitle">(Formerly Form 137)</div>
              </div>
              <img src="https://i.imgur.com/RKIOhcX.png" alt="Right Logo" class="logo-right">
            </div>

            <div class="section-header">LEARNER'S PERSONAL INFORMATION</div>
            <div class="info-row">
              <div class="info-item">
                <span class="info-label">LAST NAME:</span>
                <span class="info-value">${profileData[1] || ''}</span>
              </div>
              <div class="info-item">
                <span class="info-label">FIRST NAME:</span>
                <span class="info-value">${profileData[2] || ''}</span>
              </div>
              <div class="info-item">
                <span class="info-label">NAME EXTN. (Jr, I, II):</span>
                <span class="info-value ${!profileData[3] ? 'empty' : ''}">${profileData[3] || ''}</span>
              </div>
              <div class="info-item">
                <span class="info-label">MIDDLE NAME:</span>
                <span class="info-value">${profileData[4] || ''}</span>
              </div>
            </div>
            <div class="spacer"></div>
            <div class="info-row">
              <div class="info-item">
                <span class="info-label">Learner Reference Number (LRN):</span>
                <span class="info-value">${profileData[5] || ''}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Birthdate (mm/dd/yyyy):</span>
                <span class="info-value">${profileData[6] || ''}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Sex:</span>
                <span class="info-value">${profileData[7] || ''}</span>
              </div>
            </div>

            <div class="section-header">ELIGIBILITY FOR ELEMENTARY SCHOOL ENROLMENT</div>
            <div class="eligibility-section">
              <div class="eligibility-row">
                <span class="eligibility-label italic">Credentials Presented for Grade 1:</span>
                <div class="checkbox-group">
                  <span class="checkbox ${profileData[8] === 'TRUE' ? 'checked' : ''}"></span>
                  <span class="italic">Kinder Progress Report</span>
                </div>
                <div class="checkbox-group">
                  <span class="checkbox ${profileData[9] === 'TRUE' ? 'checked' : ''}"></span>
                  <span class="italic">ECCD Checklist</span>
                </div>
                <div class="checkbox-group">
                  <span class="checkbox ${profileData[10] === 'TRUE' ? 'checked' : ''}"></span>
                  <span class="italic">Kindergarten Certificate of Completion</span>
                </div>
              </div>
              <div class="eligibility-row">
                <div class="eligibility-item">
                  <span class="eligibility-label">Name of School:</span>
                  <span class="info-value school-name-value">${profileData[11] || ''}</span>
                </div>
                <div class="eligibility-item">
                  <span class="eligibility-label">School ID:</span>
                  <span class="info-value school-id-value">${profileData[12] || ''}</span>
                </div>
                <div class="eligibility-item">
                  <span class="eligibility-label">Address of School:</span>
                  <span class="info-value school-address-value">${profileData[13] || ''}</span>
                </div>
              </div>
            </div>

            <div class="other-credential-section">
              <div>Other Credential Presented</div>
              <div class="other-credential-row indent">
                <span class="checkbox ${profileData[14] === 'TRUE' ? 'checked' : ''}"></span>
                <span class="space-after">EPT Passer</span>
                <span class="space-after">Rating:</span>
                <span class="underline space-after">${profileData[15] || ''}</span>
                <span class="space-after">Date of Examination/Assessment (mm/dd/yyyy):</span>
                <span class="underline space-after">${profileData[16] || ''}</span>
                <span class="checkbox ${profileData[17] ? 'checked' : ''}"></span>
                <span>Others (Pls. Specify):</span>
                <span class="underline">${profileData[17] || ''}</span>
              </div>
              <div class="other-credential-row indent">
                <span>Name and Address of Testing Center:</span>
                <span class="underline space-after">${profileData[18] || ''}</span>
                <span>Remark:</span>
                <span class="underline">${profileData[19] || ''}</span>
              </div>
            </div>

            <div class="section-header">SCHOLASTIC RECORD</div>
            <div class="scholastic-record">
          ${createBox134(profileData, scholasticData, 1)}
          ${createBox2(profileData, scholasticData)}
        </div>
        
        <div class="remedial-tables">
          ${createRemedialTable()}
          ${createRemedialTable()}
        </div>

        <div class="scholastic-record">
          ${createBox134(profileData, scholasticData, 3)}
          ${createBox134(profileData, scholasticData, 4)}
        </div>
        
        <div class="remedial-tables-34">
          ${createRemedialTable34(3)}
          ${createRemedialTable34(4)}
        </div>

        <!-- New elements -->
        <div style="height: 20px;"></div>
        <div class="page-info-a">
          <span> </span>
          
        </div>
        <div class="page-info-2">
          <span>SF10-ES</span>
          <span>Page 2 of 2</span>
        </div>

        <div style="height: 1px;"></div>

        <div class="section-header-2">SCHOLASTIC RECORD</div>

         <!-- Box 5 -->
        <div class="scholastic-record">
          ${createBox134(profileData, scholasticData, 5)}
          ${createBox134(profileData, scholasticData, 6)}
        </div>


        <!-- Remedial Table for Box 5 and 6 -->
        <div class="remedial-tables-6">
          ${createRemedialTable34(5)}
          ${createRemedialTable34(6)}
        </div>

        <div class="scholastic-record">
          ${createBox134(profileData, scholasticData, 7)}
          ${createBox134(profileData, scholasticData, 8)}
        </div>

        <!-- Remedial Table for Box 7 -->
        <div class="remedial-tables-7">
          ${createRemedialTable34(7)}
          ${createRemedialTable34(8)}
        </div>


        <div class="certification-header-transfer">
  <span>For Transfer Out / Elementary School Completer Only</span>
</div>
<div style="height: 5px;"></div>
<table class="certification-tables">
  <tr><td class="certification-header"><span>CERTIFICATION</span></td></tr>
  <tr><td class="certification-content" id="certification-row-2"></td></tr>
  <tr class="certification-row-3"><td class="certification-content" id="certification-row-3"></td></tr>
  
  
  <tr id="certification-row-6">
            <td style="padding: 0;">
              <table style="width: 100%; margine:0;">
                <tr>
                  <td style="width: 10%;"></td>
                  <td style="width: 16.28%;">_________________________</td>
                  <td style="width: 13.28%;"></td>
                  <td style="width: 32.84%;" colspan="2">___________________________________</td>
                  <td style="width: 10.28%;"></td>
                  <td style="width: 17.28%;"></td>
                </tr>
              </table>
            </td>
          </tr>
          <tr id="certification-row-7">
            <td style="padding: 0;">
              <table style="width: 100%; margine:0;">
                <tr>
                  <td style="width: 10%;"></td>
                  <td style="width: 16.28%;">Date</td>
                  <td style="width: 13.28%;"></td>
                  <td style="width: 32.84%;" colspan="2">Signature of Principal/School Head over Printed Name</td>
                  <td style="width: 10.28%;"></td>
                  <td style="width: 17.28%;">(Affix School Seal here)</td>
                </tr>
              </table>
            </td>
          </tr>
        </table>

        <div style="height: 5px;"></div>
  <table class="certification-tables">
  <tr><td class="certification-header"><span>CERTIFICATION</span></td></tr>
  <tr><td class="certification-content-2">I CERTIFY that this is a true record of _______________________ with LRN __________________ and that he/she is eligible for admission to Grade ___.</td></tr>
  <tr class="certification-row-3"><td class="certification-content-2">School Name: __________________________ School ID: ____________ Division: ______________________ Last School Year Attended: ________.</td></tr>
  
  <tr id="certification-row-6">
            <td style="padding: 0;">
              <table style="width: 100%; margine:0;">
                <tr>
                  <td style="width: 10%;"></td>
                  <td style="width: 16.28%;">_________________________</td>
                  <td style="width: 13.28%;"></td>
                  <td style="width: 32.84%;" colspan="2">___________________________________</td>
                  <td style="width: 10.28%;"></td>
                  <td style="width: 17.28%;"></td>
                </tr>
              </table>
            </td>
          </tr>
          <tr id="certification-row-7">
            <td style="padding: 0;">
              <table style="width: 100%; margine:0;">
                <tr>
                  <td style="width: 10%;"></td>
                  <td style="width: 16.28%;">Date</td>
                  <td style="width: 13.28%;"></td>
                  <td style="width: 32.84%;" colspan="2">Signature of Principal/School Head over Printed Name</td>
                  <td style="width: 10.28%;"></td>
                  <td style="width: 17.28%;">(Affix School Seal here)</td>
                </tr>
              </table>
            </td>
          </tr>
        </table>

        <div style="height: 5px;"></div>
  <table class="certification-tables">
  <tr><td class="certification-header"><span>CERTIFICATION</span></td></tr>
  <tr><td class="certification-content-2">I CERTIFY that this is a true record of _______________________ with LRN __________________ and that he/she is eligible for admission to Grade ___.</td></tr>
  <tr class="certification-row-3"><td class="certification-content-2">School Name: __________________________ School ID: ____________ Division: ______________________ Last School Year Attended: ________.</td></tr>
  <tr id="certification-row-6">
            <td style="padding: 0;">
              <table style="width: 100%; margine:0;">
                <tr>
                  <td style="width: 10%;"></td>
                  <td style="width: 16.28%;">_________________________</td>
                  <td style="width: 13.28%;"></td>
                  <td style="width: 32.84%;" colspan="2">___________________________________</td>
                  <td style="width: 10.28%;"></td>
                  <td style="width: 17.28%;"></td>
                </tr>
              </table>
            </td>
          </tr>
          <tr id="certification-row-7">
            <td style="padding: 0;">
              <table style="width: 100%; margine:0;">
                <tr>
                  <td style="width: 10%;"></td>
                  <td style="width: 16.28%;">Date</td>
                  <td style="width: 13.28%;"></td>
                  <td style="width: 32.84%;" colspan="2">Signature of Principal/School Head over Printed Name</td>
                  <td style="width: 10.28%;"></td>
                  <td style="width: 17.28%;">(Affix School Seal here)</td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
        <div class="page-end">
          <span>May Add Certification Box if needed</span>
          <span>SFRT Revised 2017</span>
        </div>
        </body>
      </html>
      `);

      resultsWindow.document.close();

      resultsWindow.getNextGrade = getNextGrade;
  resultsWindow.getLastSchoolYear = getLastSchoolYear;

  // Define the populateCertificationTable function in the new window
  resultsWindow.populateCertificationTable = function(profileData, scholasticData, searchName) {
    console.log("populateCertificationTable called");
    console.log("profileData:", profileData);
    console.log("scholasticData:", scholasticData);

    const row2 = this.document.getElementById('certification-row-2');
    const row3 = this.document.getElementById('certification-row-3');

    console.log("row2:", row2);
    console.log("row3:", row3);

    if (!row2 || !row3) {
      console.error("Certification rows not found in the DOM");
      return;
    }

    const learnerName = profileData[0] || 'N/A';
    const lrn = profileData[5] || 'N/A';
    const nextGrade = getNextGrade(profileData, scholasticData);

    console.log("learnerName:", learnerName);
    console.log("lrn:", lrn);
    console.log("nextGrade:", nextGrade);

    row2.innerHTML = `<b>I CERTIFY that this is a true record of</b> <u>${learnerName}</u> <b>with LRN</b> <u>${lrn}</u> <b>and that he/she is eligible for admission to Grade</b> <u>${nextGrade}</u>.`;

    const schoolName = profileData[30] || 'N/A';
    const schoolId = profileData[29] || 'N/A';
    const division = profileData[25] || 'N/A';
    const lastSchoolYear = getLastSchoolYear(profileData);

    console.log("schoolName:", schoolName);
    console.log("schoolId:", schoolId);
    console.log("division:", division);
    console.log("lastSchoolYear:", lastSchoolYear);

    row3.innerHTML = `<b>School Name:</b> <u>${schoolName}</u> <b>School ID:</b> <u>${schoolId}</u> <b>Division:</b> <u>${division}</u> <b>Last School Year Attended:</b> <u>${lastSchoolYear}</u>`;

    console.log("Certification table populated");
  };

  // Call the function with the data when the window is loaded
  resultsWindow.onload = function() {
    console.log("Results window loaded");
    this.populateCertificationTable(profileData, scholasticData, searchName);
  };
}

// Define these functions in the main window scope
function getNextGrade(profileData, scholasticData) {
  console.log("Starting getNextGrade function");

  const gradeFunctions = [
    getGradeData,
    getGradeDataBox2,
    getGradeDataBox3,
    getGradeDataBox4,
    getGradeDataBox5,
    getGradeDataBox6,
    getGradeDataBox7,
    getGradeDataBox8
  ];

  let promotedCount = 0;

  for (let i = gradeFunctions.length - 1; i >= 0; i--) {
    const boxNumber = i + 1;
    let gradeValue, schoolYearValue;

    if (boxNumber === 1) {
      gradeValue = profileData[22];
      schoolYearValue = profileData[20];
    } else {
      gradeValue = profileData[34 + (boxNumber - 2) * 9]; // Adjusted index for grade
      schoolYearValue = profileData[32 + (boxNumber - 2) * 9]; // Adjusted index for school year
    }

    console.log(`Box ${boxNumber} input:`, { gradeValue, schoolYearValue });

    if (gradeValue && schoolYearValue) {
      const result = gradeFunctions[i](22, gradeValue, schoolYearValue, scholasticData, 1);
      console.log(`Box ${boxNumber} result: ${JSON.stringify(result)}`);
      
      if (result.remarks === "PROMOTED") {
        promotedCount++;
        console.log(`Promoted count increased to ${promotedCount}`);
      }
    } else {
      console.log(`Box ${boxNumber} is empty or incomplete`);
    }
  }

  const nextGrade = promotedCount + 1;
  console.log(`Final Next Grade: ${nextGrade}`);
  return nextGrade;
}

function getLastSchoolYear(profileData) {
  // Check boxes 8 to 3 from createBox134
  const boxIndices = [92, 82, 72, 62, 52, 42];
  
  for (let index of boxIndices) {
    const schoolYearValue = profileData[index];
    if (schoolYearValue && schoolYearValue.trim() !== "") {
      console.log(`Returning school year from Box ${8 - boxIndices.indexOf(index)}: ${schoolYearValue}`);
      return schoolYearValue;
    }
  }

  // If no school year found in boxes 8 to 3, check Box 2
  const box2SchoolYear = profileData[32];
  if (box2SchoolYear && box2SchoolYear.trim() !== "") {
    console.log(`Returning school year from Box 2: ${box2SchoolYear}`);
    return box2SchoolYear;
  }

  // If Box 2 is also empty, use Box 1
  const box1SchoolYear = profileData[20];
  console.log(`Returning school year from Box 1: ${box1SchoolYear}`);
  return box1SchoolYear || "";
}


      function getRow7Column1Text(gradeValue, schoolYearValue) {
        // Extract the first four characters of the school year and convert to a number
        const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
        
        // Convert grade to a number (in case it's stored as a string)
        const grade = parseInt(gradeValue, 10);

        if (grade === 1 && schoolYearStart > 2023) {
          return "Language";
        } else if (grade > 1 && schoolYearStart > 2023) {
          return "Filipino";
        } else {
          return "Mother Tongue";
        }
      }

      function getRow8Column1Text(gradeValue, schoolYearValue) {
        // Extract the first four characters of the school year and convert to a number
        const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
        
        // Convert grade to a number (in case it's stored as a string)
        const grade = parseInt(gradeValue, 10);

        if (grade === 1 && schoolYearStart > 2023) {
          return "Reading and Literacy";
        } else if (grade > 1 && schoolYearStart > 2023) {
          return "English";
        } else {
          return "Filipino";
        }
      }

      function getRow9Column1Text(gradeValue, schoolYearValue) {
        // Extract the first four characters of the school year and convert to a number
        const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
        
        // Convert grade to a number (in case it's stored as a string)
        const grade = parseInt(gradeValue, 10);

        if (grade < 7 && schoolYearStart > 2023) {
          return "Mathematics";
        } else {
          return "English";
        }
      }

      function getRow10Column1Text(gradeValue, schoolYearValue) {
        // Extract the first four characters of the school year and convert to a number
        const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
        
        // Convert grade to a number (in case it's stored as a string)
        const grade = parseInt(gradeValue, 10);

        if (schoolYearStart > 2023) {
          if (grade < 4) {
            return "Makabansa";
          } else if (grade >= 4) {
            return "Araling Panlipunan";
          }
        }
        return "Mathematics";
      }

      function getRow11Column1Text(gradeValue, schoolYearValue) {
        // Extract the first four characters of the school year and convert to a number
        const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
        
        // Convert grade to a number (in case it's stored as a string)
        const grade = parseInt(gradeValue, 10);

        if (grade < 7 && schoolYearStart > 2023) {
          return "GMRC";
        } else {
          return "Science";
        }
      }

      function getRow12Column1Text(gradeValue, schoolYearValue) {
        // Extract the first four characters of the school year and convert to a number
        const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
        
        // Convert grade to a number (in case it's stored as a string)
        const grade = parseInt(gradeValue, 10);

        if (grade < 3 && schoolYearStart > 2023) {
          return ""; // Empty string for grades 1-2 after 2023
        } else if (schoolYearStart > 2023 && grade < 7) {
          return "Science";
        } else {
          return "Araling Panlipunan";
        }
      }

      function getRow13Column1Text(gradeValue, schoolYearValue) {
        // Extract the first four characters of the school year and convert to a number
        const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
        
        // Convert grade to a number (in case it's stored as a string)
        const grade = parseInt(gradeValue, 10);

        if (schoolYearStart > 2023 && grade < 4) {
          return ""; // Empty string for grades 1-3 after 2023
        } else {
          return "EPP / TLE";
        }
      }

      function getRow14Column1Text(gradeValue, schoolYearValue) {
        // Extract the first four characters of the school year and convert to a number
        const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
        
        // Convert grade to a number (in case it's stored as a string)
        const grade = parseInt(gradeValue, 10);

        if (schoolYearStart > 2023 && grade < 4) {
          return ""; // Empty string for grades 1-3 after 2023
        } else {
          return "MAPEH";
        }
      }

      function getRow15Column1Text(gradeValue, schoolYearValue) {
        // Extract the first four characters of the school year and convert to a number
        const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
        
        // Convert grade to a number (in case it's stored as a string)
        const grade = parseInt(gradeValue, 10);

        if (schoolYearStart > 2023) {
          if (grade < 4) {
            return ""; // Empty string for grades 1-3 after 2023
          } else if (grade >= 4) {
            return "&nbsp;&nbsp;&nbsp;&nbsp;Music and Arts"; // Four non-breaking spaces before "Music and Arts" for grades 4 and above after 2023
          }
        }
        return "&nbsp;&nbsp;&nbsp;&nbsp;Music"; // Four non-breaking spaces before "Music" for all other cases
      }

      function getRow16Column1Text(gradeValue, schoolYearValue) {
        // Extract the first four characters of the school year and convert to a number
        const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
        
        // Convert grade to a number (in case it's stored as a string)
        const grade = parseInt(gradeValue, 10);

        if (schoolYearStart > 2023) {
          if (grade < 4) {
            return ""; // Empty string for grades 1-3 after 2023
          } else if (grade >= 4) {
            return "&nbsp;&nbsp;&nbsp;&nbsp;Physical Education and Health"; // Four non-breaking spaces before "Physical Education and Health" for grades 4 and above after 2023
          }
        }
        return "&nbsp;&nbsp;&nbsp;&nbsp;Arts"; // Four non-breaking spaces before "Arts" for all other cases
      }

      function getRow17Column1Text(gradeValue, schoolYearValue) {
        // Extract the first four characters of the school year and convert to a number
        const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
        
        // Convert grade to a number (in case it's stored as a string)
        const grade = parseInt(gradeValue, 10);

        if (schoolYearStart > 2023 && grade < 7) {
          return ""; // Empty string for grades 1-6 after 2023
        } else {
          return "&nbsp;&nbsp;&nbsp;&nbsp;Physical Education"; // Four non-breaking spaces before "Physical Education" for all other cases
        }
      }

      function getRow18Column1Text(gradeValue, schoolYearValue) {
        // Extract the first four characters of the school year and convert to a number
        const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
        
        // Convert grade to a number (in case it's stored as a string)
        const grade = parseInt(gradeValue, 10);

        if (schoolYearStart > 2023 && grade < 7) {
          return ""; // Empty string for grades 1-6 after 2023
        } else {
          return "&nbsp;&nbsp;&nbsp;&nbsp;Health"; // Four non-breaking spaces before "Health" for all other cases
        }
      }

      function getRow19Column1Text(gradeValue, schoolYearValue) {
        // Extract the first four characters of the school year and convert to a number
        const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
        
        // Convert grade to a number (in case it's stored as a string)
        const grade = parseInt(gradeValue, 10);

        if (schoolYearStart > 2023 && grade < 7) {
          return ""; // Empty string for grades 1-6 after 2023
        } else {
          return "Eduk. sa Pagpapakatao"; // No leading spaces for this text
        }
      }

      function getRow20Column1Text() {
        return "&nbsp;&nbsp;&nbsp;&nbsp;*Arabic Language";
      }

      function getRow21Column1Text() {
        return "&nbsp;&nbsp;&nbsp;&nbsp;*Islamic Values Education";
      }

  function createBox134(profileData, scholasticData, boxNumber) {
  const isBox1 = boxNumber === 1;
  const isBox3 = boxNumber === 3;
  const isBox4 = boxNumber === 4;
  const isBox5 = boxNumber === 5;
  const isBox6 = boxNumber === 6;
  const isBox7 = boxNumber === 7;
  const isBox8 = boxNumber === 8;


  let gradeValue, schoolYearValue, schoolValue, schoolIdValue, districtValue, divisionValue, regionValue, sectionValue, adviserValue, signatureValue;

  if (isBox1) {
    gradeValue = profileData[22];
    schoolYearValue = profileData[20];
    schoolValue = profileData[30];
    schoolIdValue = profileData[29];
    districtValue = profileData[28];
    divisionValue = profileData[25];
    regionValue = profileData[24];
    sectionValue = profileData[23];
    adviserValue = profileData[21];
    signatureValue = profileData[102];
  } else if (isBox3) {
    gradeValue = profileData[44];
    schoolYearValue = profileData[42];
    schoolValue = profileData[50];
    schoolIdValue = profileData[49];
    districtValue = profileData[48];
    divisionValue = profileData[47];
    regionValue = profileData[46];
    sectionValue = profileData[45];
    adviserValue = profileData[43];
    signatureValue = profileData[104];
  } else if (isBox4) {
    gradeValue = profileData[54];
    schoolYearValue = profileData[52];
    schoolValue = profileData[60];
    schoolIdValue = profileData[59];
    districtValue = profileData[58];
    divisionValue = profileData[57];
    regionValue = profileData[56];
    sectionValue = profileData[55];
    adviserValue = profileData[53];
    signatureValue = profileData[105];
  } else if (isBox5) {
    gradeValue = profileData[64];
    schoolYearValue = profileData[62];
    schoolValue = profileData[70];
    schoolIdValue = profileData[69];
    districtValue = profileData[68];
    divisionValue = profileData[67];
    regionValue = profileData[66];
    sectionValue = profileData[65];
    adviserValue = profileData[63];
    signatureValue = profileData[106];
  } else if (isBox6) {
    gradeValue = profileData[74];
    schoolYearValue = profileData[72];
    schoolValue = profileData[80];
    schoolIdValue = profileData[79];
    districtValue = profileData[78];
    divisionValue = profileData[77];
    regionValue = profileData[76];
    sectionValue = profileData[75];
    adviserValue = profileData[73];
    signatureValue = profileData[107];
  } else if (isBox7) {
    schoolYearValue = profileData[82]; // Column CA
    adviserValue = profileData[83];    // Column CB
    gradeValue = profileData[84];      // Column CC
    sectionValue = profileData[85];    // Column CD
    regionValue = profileData[86];     // Column CE
    divisionValue = profileData[87];   // Column CF
    districtValue = profileData[88];   // Column CG
    schoolIdValue = profileData[89];   // Column CH
    schoolValue = profileData[90];     // Column CI
    signatureValue = profileData[108]; // Column CY
  } else if (isBox8) {
    schoolYearValue = profileData[92]; // Column CA
    adviserValue = profileData[93];    // Column CB
    gradeValue = profileData[94];      // Column CC
    sectionValue = profileData[95];    // Column CD
    regionValue = profileData[96];     // Column CE
    divisionValue = profileData[97];   // Column CF
    districtValue = profileData[98];   // Column CG
    schoolIdValue = profileData[99];   // Column CH
    schoolValue = profileData[100];     // Column CI
    signatureValue = profileData[109]; // Column CY
  }

  let gradesSection = `
    <!-- Grades Section Header (Rows 5 and 6) -->
    <tr class="grades-header-row">
      <td colspan="9" rowspan="2" class="grades-area-label">LEARNING AREAS</td>
      <td colspan="4" class="grades-quarter-label">Quarterly Rating</td>
      <td colspan="3" rowspan="2" class="grades-final-label">Final<br>Rating</td>
      <td colspan="3" rowspan="2" class="grades-remarks-label">Remarks</td>
    </tr>
    <tr class="grades-header-row">
      <td class="grades-quarter-num">1</td>
      <td class="grades-quarter-num">2</td>
      <td class="grades-quarter-num">3</td>
      <td class="grades-quarter-num">4</td>
    </tr>
  `;

  // Add rows 7 to 22 with merged cells in the first column
  for (let i = 7; i <= 22; i++) {
    let subjectText = getSubjectText(i, gradeValue, schoolYearValue);
    let cellClass = 'subject-cell';
    
    if ((i >= 7 && i <= 14) || i === 19 || i === 22) {
      cellClass += ' subject-cell-bold';
    } else if ((i >= 15 && i <= 18) || i === 20 || i === 21) {
      cellClass += ' subject-cell-italic';
    }

    let gradeData;
    if (isBox3) {
      gradeData = getGradeDataBox3(i, gradeValue, schoolYearValue, scholasticData);
    } else if (isBox4) {
      gradeData = getGradeDataBox4(i, gradeValue, schoolYearValue, scholasticData);
    } else if (isBox5) {
      gradeData = getGradeDataBox5(i, gradeValue, schoolYearValue, scholasticData);
    } else if (isBox6) {
      gradeData = getGradeDataBox6(i, gradeValue, schoolYearValue, scholasticData);
    } else if (isBox7) {
      gradeData = getGradeDataBox7(i, gradeValue, schoolYearValue, scholasticData);
    } else if (isBox8) {
      gradeData = getGradeDataBox8(i, gradeValue, schoolYearValue, scholasticData);
    } else {
      gradeData = getGradeData(i, gradeValue, schoolYearValue, scholasticData, boxNumber);
    }

    gradesSection += `
      <tr class="grades-data-row">
        <td colspan="9" class="${cellClass}" style="white-space: pre-wrap;">${subjectText}</td>
        <td class="grade-cell">${gradeData.q1}</td>
        <td class="grade-cell">${gradeData.q2}</td>
        <td class="grade-cell">${gradeData.q3}</td>
        <td class="grade-cell">${gradeData.q4}</td>
        <td colspan="3" class="final-grade-cell">${gradeData.final}</td>
        <td colspan="3" class="remarks-cell">${gradeData.remarks}</td>
      </tr>
    `;
  }

  return `
    <table class="box">
      <tr>
        <td colspan="14">
          <span class="label" id="box${boxNumber}-school-label">School:</span>
          ${displayValue(schoolValue, 180)}
        </td>
        <td colspan="5" class="school-id-container">
          <span class="label" id="box${boxNumber}-school-id-label">School ID:</span>
          ${displayValue(schoolIdValue, 35)}
        </td>
      </tr>
      <tr>
        <td colspan="8">
          <span class="label" id="box${boxNumber}-district-label">District:</span>
          ${displayValue(districtValue, 95)}
        </td>
        <td colspan="8">
          <span class="label" id="box${boxNumber}-division-label">Division:</span>
          ${displayValue(divisionValue, 97)}
        </td>
        <td colspan="3" class="region-container">
          <span class="label" id="box${boxNumber}-region-label">Region:</span>
          ${displayValue(regionValue, 15)}
        </td>
      </tr>
      <tr>
        <td colspan="6" style="width: 31.5%;">
          <span class="label" id="box${boxNumber}-grade-label">Classified as Grade:</span>
          ${displayValue(gradeValue, 56)}
        </td>
        <td colspan="8" style="width: 42%;">
          <span class="label" id="box${boxNumber}-section-label">Section:</span>
          ${displayValue(sectionValue, 70)}
        </td>
        <td colspan="5" style="width: 26.5%;" class="school-year-container">
          <span class="label" id="box${boxNumber}-school-year-label">School Year:</span>
          ${displayValue(schoolYearValue, 42, true)}
        </td>
      </tr>
      <tr>
        <td colspan="13">
          <span class="label" id="box${boxNumber}-adviser-label">Name of Adviser/Teacher:</span>
          ${displayValue(adviserValue, 150)}
        </td>
        <td colspan="2">
          <span class="label" id="box${boxNumber}-signature-label">Signature:</span>
        </td>
        <td colspan="4">
          ${displaySignature(signatureValue, 100)}
        </td>
      </tr>
      ${gradesSection}
    </table>
  `;
}

      function createRemedialTable() {
        let tableHTML = '<table class="remedial-table">';
        
        // Row 1 with merged cells and specified content
        tableHTML += `
          <tr>
            <td colspan="4" class="remedial-header">Remedial Classes</td>
            <td colspan="4" class="remedial-header">Conducted from</td>
            <td colspan="5"></td>
            <td class="remedial-header">to:</td>
            <td colspan="5"></td>
          </tr>
        `;

        // Row 2 and 3 (merged)
        tableHTML += `
          <tr>
            <td colspan="5" rowspan="2" class="remedial-subheader">Learning Areas</td>
            <td colspan="3" rowspan="2" class="remedial-subheader">Final Rating</td>
            <td colspan="4" rowspan="2" class="remedial-subheader">Remedial Class Mark</td>
            <td colspan="5" rowspan="2" class="remedial-subheader">Recomputed Final Grade</td>
            <td colspan="2" rowspan="2" class="remedial-subheader">Remarks</td>
          </tr>
          <tr></tr>
        `;

        // Rows 4 and 5 (modified)
        for (let i = 0; i < 2; i++) {
          tableHTML += `
            <tr>
              <td colspan="5"></td>
              <td colspan="3"></td>
              <td colspan="4"></td>
              <td colspan="5"></td>
              <td colspan="2"></td>
            </tr>
          `;
        }

        tableHTML += '</table>';
        return tableHTML;
      }

      function createBox34(data, boxNumber) {
        const isBox3 = boxNumber === 3;
        const gradeValue = isBox3 ? data[44] : data[54]; // AS for Box 3, BB for Box 4
        const schoolYearValue = isBox3 ? data[42] : data[52]; // AQ for Box 3, AZ for Box 4

        let gradesSection = `
          <!-- Grades Section Header (Rows 5 and 6) -->
          <tr class="grades-header-row">
            <td colspan="9" rowspan="2" class="grades-area-label">LEARNING AREAS</td>
            <td colspan="4" class="grades-quarter-label">Quarterly Rating</td>
            <td colspan="3" rowspan="2" class="grades-final-label">Final<br>Rating</td>
            <td colspan="3" rowspan="2" class="grades-remarks-label">Remarks</td>
          </tr>
          <tr class="grades-header-row">
            <td class="grades-quarter-num">1</td>
            <td class="grades-quarter-num">2</td>
            <td class="grades-quarter-num">3</td>
            <td class="grades-quarter-num">4</td>
          </tr>
        `;

        // Add rows 7 to 22 with merged cells in the first column
        for (let i = 7; i <= 22; i++) {
          let subjectText = '';
          let cellClass = 'subject-cell';
          
          if ((i >= 7 && i <= 14) || i === 19 || i === 22) {
            cellClass += ' subject-cell-bold';
          } else if ((i >= 15 && i <= 18) || i === 20 || i === 21) {
            cellClass += ' subject-cell-italic';
          }

          subjectText = getSubjectText(i, gradeValue, schoolYearValue, boxNumber);

          gradesSection += `
            <tr class="grades-data-row">
              <td colspan="9" class="${cellClass}" style="white-space: pre-wrap;">${subjectText}</td>
              <td class="grade-cell"></td>
              <td class="grade-cell"></td>
              <td class="grade-cell"></td>
              <td class="grade-cell"></td>
              <td colspan="3" class="final-grade-cell"></td>
              <td colspan="3" class="remarks-cell"></td>
            </tr>
          `;
        }

        return `
          <table class="box">
            <tr>
              <td colspan="14">
                <span class="label" id="box${boxNumber}-school-label">School:</span>
                ${displayValue(isBox3 ? data[50] : data[59], 180)} <!-- AY for Box 3, BH for Box 4 -->
              </td>
              <td colspan="5" class="school-id-container">
                <span class="label" id="box${boxNumber}-school-id-label">School ID:</span>
                ${displayValue(isBox3 ? data[49] : data[58], 35)} <!-- AX for Box 3, BG for Box 4 -->
              </td>
            </tr>
            <tr>
              <td colspan="8">
                <span class="label" id="box${boxNumber}-district-label">District:</span>
                ${displayValue(isBox3 ? data[48] : data[57], 95)} <!-- AW for Box 3, BF for Box 4 -->
              </td>
              <td colspan="8">
                <span class="label" id="box${boxNumber}-division-label">Division:</span>
                ${displayValue(isBox3 ? data[47] : data[56], 97)} <!-- AV for Box 3, BE for Box 4 -->
              </td>
              <td colspan="3" class="region-container">
                <span class="label" id="box${boxNumber}-region-label">Region:</span>
                ${displayValue(isBox3 ? data[46] : data[55], 15)} <!-- AU for Box 3, BD for Box 4 -->
              </td>
            </tr>
            <tr>
              <td colspan="6" style="width: 31.5%;">
                <span class="label" id="box${boxNumber}-grade-label">Classified as Grade:</span>
                ${displayValue(gradeValue, 56)}
              </td>
              <td colspan="8" style="width: 42%;">
                <span class="label" id="box${boxNumber}-section-label">Section:</span>
                ${displayValue(isBox3 ? data[45] : data[54], 70)} <!-- AT for Box 3, BC for Box 4 -->
              </td>
              <td colspan="5" style="width: 26.5%;" class="school-year-container">
                <span class="label" id="box${boxNumber}-school-year-label">School Year:</span>
                ${displayValue(schoolYearValue, 42, true)}
              </td>
            </tr>
            <tr>
              <td colspan="13">
                <span class="label" id="box${boxNumber}-adviser-label">Name of Adviser/Teacher:</span>
                ${displayValue(isBox3 ? data[43] : data[53], 150)} <!-- AR for Box 3, BA for Box 4 -->
              </td>
              <td colspan="2">
                <span class="label" id="box${boxNumber}-signature-label">Signature:</span>
              </td>
              <td colspan="4">
                ${displaySignature(isBox3 ? data[98] : data[99], 100)} <!-- CU for Box 3, CV for Box 4 -->
              </td>
            </tr>
            ${gradesSection}
          </table>
        `;
      }

      function getSubjectText(rowNumber, gradeValue, schoolYearValue, boxNumber) {
        // Extract the first four characters of the school year and convert to a number
        const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
        
        // Convert grade to a number (in case it's stored as a string)
        const grade = parseInt(gradeValue, 10);

        if (rowNumber === 7) {
          if (grade === 1 && schoolYearStart > 2023) {
            return "Language";
          } else if (grade > 1 && schoolYearStart > 2024) {
            return "Filipino";
          } else {
            return "Mother Tongue";
          }
        } else if (rowNumber === 8) {
          if (grade === 1 && schoolYearStart > 2023) {
            return "Reading and Literacy";
          } else if (grade > 1 && schoolYearStart > 2024) {
            return "English";
          } else {
            return "Filipino";
          }
        } else if (rowNumber === 9) {
          if (grade < 7 && schoolYearStart > 2024) {
            return "Mathematics";
          } else {
            return "English";
          }
        } else if (rowNumber === 10) {
          if (schoolYearStart > 2024) {
            if (grade < 4) {
              return "Makabansa";
            } else if (grade >= 4) {
              return "Araling Panlipunan";
            }
          }
          return "Mathematics";
        } else if (rowNumber === 11) {
          if (grade < 7 && schoolYearStart > 2024) {
            return "GMRC";
          } else {
            return "Science";
          }
        } else if (rowNumber === 12) {
          if (grade < 3 && schoolYearStart > 2024) {
            return ""; // Empty string for grades 1-2 after 2023
          } else if (schoolYearStart > 2024 && grade < 7) {
            return "Science";
          } else {
            return "Araling Panlipunan";
          }
        } else if (rowNumber === 13) {
          if (schoolYearStart > 2024 && grade < 4) {
            return ""; // Empty string for grades 1-3 after 2023
          } else {
            return "EPP / TLE";
          }
        } else if (rowNumber === 14) {
          if (schoolYearStart > 2024 && grade < 4) {
            return ""; // Empty string for grades 1-3 after 2023
          } else {
            return "MAPEH";
          }
        } else if (rowNumber === 15) {
          if (schoolYearStart > 2024) {
            if (grade < 4) {
              return ""; // Empty string for grades 1-3 after 2023
            } else if (grade >= 4) {
              return "&nbsp;&nbsp;&nbsp;&nbsp;Music and Arts"; // Four non-breaking spaces before "Music and Arts" for grades 4 and above after 2023
            }
          }
          return "&nbsp;&nbsp;&nbsp;&nbsp;Music"; // Four non-breaking spaces before "Music" for all other cases
        } else if (rowNumber === 16) {
          if (schoolYearStart > 2024) {
            if (grade < 4) {
              return ""; // Empty string for grades 1-3 after 2023
            } else if (grade >= 4) {
              return "&nbsp;&nbsp;&nbsp;&nbsp;Physical Education and Health"; // Four non-breaking spaces before "Physical Education and Health" for grades 4 and above after 2023
            }
          }
          return "&nbsp;&nbsp;&nbsp;&nbsp;Arts"; // Four non-breaking spaces before "Arts" for all other cases
        } else if (rowNumber === 17) {
          if (schoolYearStart > 2024 && grade < 7) {
            return ""; // Empty string for grades 1-6 after 2023
          } else {
            return "&nbsp;&nbsp;&nbsp;&nbsp;Physical Education"; // Four non-breaking spaces before "Physical Education" for all other cases
          }
        } else if (rowNumber === 18) {
          if (schoolYearStart > 2024 && grade < 7) {
            return ""; // Empty string for grades 1-6 after 2023
          } else {
            return "&nbsp;&nbsp;&nbsp;&nbsp;Health"; // Four non-breaking spaces before "Health" for all other cases
          }
        } else if (rowNumber === 19) {
          if (schoolYearStart > 2024 && grade < 7) {
            return ""; // Empty string for grades 1-6 after 2023
          } else {
            return "Eduk. sa Pagpapakatao"; // No leading spaces for this text
          }
        } else if (rowNumber === 20) {
          return "&nbsp;&nbsp;&nbsp;&nbsp;*Arabic Language";
        } else if (rowNumber === 21) {
          return "&nbsp;&nbsp;&nbsp;&nbsp;*Islamic Values Education";
        } else if (rowNumber === 22) {
          return "General Average";
        }
      }

      function createRemedialTable34(boxNumber) {
        return `
          <table class="remedial-table">
            <tr>
              <td colspan="4" class="remedial-header">Remedial Classes</td>
              <td colspan="4" class="remedial-header">Conducted from</td>
              <td colspan="5"></td>
              <td class="remedial-header">to:</td>
              <td colspan="5"></td>
            </tr>
            <tr>
              <td colspan="5" rowspan="2" class="remedial-subheader">Learning Areas</td>
              <td colspan="3" rowspan="2" class="remedial-subheader">Final Rating</td>
              <td colspan="4" rowspan="2" class="remedial-subheader">Remedial Class Mark</td>
              <td colspan="5" rowspan="2" class="remedial-subheader">Recomputed Final Grade</td>
              <td colspan="2" rowspan="2" class="remedial-subheader">Remarks</td>
            </tr>
            <tr></tr>
            <tr>
              <td colspan="5"></td>
              <td colspan="3"></td>
              <td colspan="4"></td>
              <td colspan="5"></td>
              <td colspan="2"></td>
            </tr>
            <tr>
              <td colspan="5"></td>
              <td colspan="3"></td>
              <td colspan="4"></td>
              <td colspan="5"></td>
              <td colspan="2"></td>
            </tr>
          </table>
        `;
      }

      function createRemedialTable345(boxNumber) {
  return `
    <div class="remedial-tables-${boxNumber}">
      <table class="remedial-table">
        <tr>
          <td colspan="4" class="remedial-header">Remedial Classes</td>
          <td colspan="4" class="remedial-header">Conducted from</td>
          <td colspan="5"></td>
          <td class="remedial-header">to:</td>
          <td colspan="5"></td>
        </tr>
        <tr>
          <td colspan="5" rowspan="2" class="remedial-subheader">Learning Areas</td>
          <td colspan="3" rowspan="2" class="remedial-subheader">Final Rating</td>
          <td colspan="4" rowspan="2" class="remedial-subheader">Remedial Class Mark</td>
          <td colspan="5" rowspan="2" class="remedial-subheader">Recomputed Final Grade</td>
          <td colspan="2" rowspan="2" class="remedial-subheader">Remarks</td>
        </tr>
        <tr></tr>
        <tr>
          <td colspan="5"></td>
          <td colspan="3"></td>
          <td colspan="4"></td>
          <td colspan="5"></td>
          <td colspan="2"></td>
        </tr>
        <tr>
          <td colspan="5"></td>
          <td colspan="3"></td>
          <td colspan="4"></td>
          <td colspan="5"></td>
          <td colspan="2"></td>
        </tr>
      </table>
    </div>
  `;
}

function getGradeData(rowNumber, gradeValue, schoolYearValue, scholasticData, boxNumber) {
  if (boxNumber !== 1) {
    return { q1: '', q2: '', q3: '', q4: '', final: '', remarks: '' };
  }

  const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
  const grade = parseInt(gradeValue, 10);

  // Helper function to replace undefined or empty values with an empty string
  const sanitizeValue = (value) => (value === undefined || value === null || value === '') ? '' : value;

  let q1 = '', q2 = '', q3 = '', q4 = '', final = '', remarks = '';

  switch (rowNumber) {
          case 7:
            if (grade === 1 && schoolYearStart > 2023) {
              q1 = scholasticData[22]; // Column W
              q2 = scholasticData[44]; // Column AS
              q3 = scholasticData[66]; // Column BO
              q4 = scholasticData[88]; // Column CK
              final = scholasticData[110]; // Column DG
            } else if (grade > 1 && schoolYearStart > 2023) {
              q1 = scholasticData[8]; // Column I
              q2 = scholasticData[30]; // Column AE
              q3 = scholasticData[52]; // Column BA
              q4 = scholasticData[74]; // Column BW
              final = scholasticData[96]; // Column CS
            } else {
              q1 = scholasticData[7]; // Column H
              q2 = scholasticData[29]; // Column AD
              q3 = scholasticData[51]; // Column AZ
              q4 = scholasticData[73]; // Column BV
              final = scholasticData[95]; // Column CR
            }
            break;
          case 8:
            if (grade === 1 && schoolYearStart > 2023) {
              q1 = scholasticData[23]; // Column X
              q2 = scholasticData[45]; // Column AT
              q3 = scholasticData[67]; // Column BP
              q4 = scholasticData[89]; // Column CL
              final = scholasticData[111]; // Column DH
            } else if (grade > 1 && schoolYearStart > 2023) {
              q1 = scholasticData[9]; // Column J
              q2 = scholasticData[31]; // Column AF
              q3 = scholasticData[53]; // Column BB
              q4 = scholasticData[75]; // Column BX
              final = scholasticData[97]; // Column CT
            } else {
              q1 = scholasticData[8]; // Column I
              q2 = scholasticData[30]; // Column AE
              q3 = scholasticData[52]; // Column BA
              q4 = scholasticData[74]; // Column BW
              final = scholasticData[96]; // Column CS
            }
            break;
          case 9:
            if (grade < 7 && schoolYearStart > 2023) {
              q1 = scholasticData[10]; // Column K
              q2 = scholasticData[32]; // Column AG
              q3 = scholasticData[54]; // Column BC
              q4 = scholasticData[76]; // Column BY
              final = scholasticData[98]; // Column CU
            } else {
              q1 = scholasticData[9]; // Column J
              q2 = scholasticData[31]; // Column AF
              q3 = scholasticData[53]; // Column BB
              q4 = scholasticData[75]; // Column BX
              final = scholasticData[97]; // Column CT
            }
            break;
          case 10:
            if (schoolYearStart > 2023) {
              if (grade < 4) {
                q1 = scholasticData[6]; // Column G
                q2 = scholasticData[28]; // Column AC
                q3 = scholasticData[50]; // Column AY
                q4 = scholasticData[72]; // Column BU
                final = scholasticData[94]; // Column CQ
              } else if (grade >= 4) {
                q1 = scholasticData[12]; // Column M
                q2 = scholasticData[34]; // Column AI
                q3 = scholasticData[56]; // Column BE
                q4 = scholasticData[78]; // Column CA
                final = scholasticData[100]; // Column CW
              }
            } else {
              q1 = scholasticData[10]; // Column K
              q2 = scholasticData[32]; // Column AG
              q3 = scholasticData[54]; // Column BC
              q4 = scholasticData[76]; // Column BY
              final = scholasticData[98]; // Column CU
            }
            break;
          case 11:
            if (grade < 7 && schoolYearStart > 2023) {
              q1 = scholasticData[5]; // Column F
              q2 = scholasticData[27]; // Column AB
              q3 = scholasticData[49]; // Column AX
              q4 = scholasticData[71]; // Column BT
              final = scholasticData[93]; // Column CP
            } else {
              q1 = scholasticData[11]; // Column L
              q2 = scholasticData[33]; // Column AH
              q3 = scholasticData[55]; // Column BD
              q4 = scholasticData[77]; // Column BZ
              final = scholasticData[99]; // Column CV
            }
            break;
          case 12:
            if (grade < 3 && schoolYearStart > 2023) {
              q1 = q2 = q3 = q4 = final = "";
            } else if (schoolYearStart > 2023 && grade < 7) {
              q1 = scholasticData[11]; // Column L
              q2 = scholasticData[33]; // Column AH
              q3 = scholasticData[55]; // Column BD
              q4 = scholasticData[77]; // Column BZ
              final = scholasticData[99]; // Column CV
            } else {
              q1 = scholasticData[12]; // Column M
              q2 = scholasticData[34]; // Column AI
              q3 = scholasticData[56]; // Column BE
              q4 = scholasticData[78]; // Column CA
              final = scholasticData[100]; // Column CW
            }
            break;
          case 13:
            if (schoolYearStart > 2023 && grade < 4) {
              q1 = q2 = q3 = q4 = final = "";
            } else {
              q1 = scholasticData[13]; // Column N
              q2 = scholasticData[35]; // Column AJ
              q3 = scholasticData[57]; // Column BF
              q4 = scholasticData[79]; // Column CB
              final = scholasticData[101]; // Column CX
            }
            break;
          case 14:
            if (schoolYearStart > 2023 && grade < 4) {
              q1 = q2 = q3 = q4 = final = "";
            } else {
              q1 = scholasticData[20]; // Column U
              q2 = scholasticData[42]; // Column AQ
              q3 = scholasticData[64]; // Column BM
              q4 = scholasticData[86]; // Column CI
              final = scholasticData[108]; // Column DE
            }
            break;
          case 15:
            if (schoolYearStart > 2023) {
              if (grade < 4) {
                q1 = q2 = q3 = q4 = final = "";
              } else if (grade >= 4) {
                q1 = scholasticData[18]; // Column S
                q2 = scholasticData[40]; // Column AO
                q3 = scholasticData[62]; // Column BK
                q4 = scholasticData[84]; // Column CG
                final = scholasticData[106]; // Column DC
              }
            } else {
              q1 = scholasticData[14]; // Column O
              q2 = scholasticData[36]; // Column AK
              q3 = scholasticData[58]; // Column BG
              q4 = scholasticData[80]; // Column CC
              final = scholasticData[102]; // Column CY
            }
            break;
          case 16:
            if (schoolYearStart > 2023) {
              if (grade < 4) {
                q1 = q2 = q3 = q4 = final = "";
              } else if (grade >= 4) {
                q1 = scholasticData[19]; // Column T
                q2 = scholasticData[41]; // Column AP
                q3 = scholasticData[63]; // Column BL
                q4 = scholasticData[85]; // Column CH
                final = scholasticData[107]; // Column DD
              }
            } else {
              q1 = scholasticData[15]; // Column P
              q2 = scholasticData[37]; // Column AL
              q3 = scholasticData[59]; // Column BH
              q4 = scholasticData[81]; // Column CD
              final = scholasticData[103]; // Column CZ
            }
            break;
          case 17:
            if (schoolYearStart > 2023 && grade < 7) {
              q1 = q2 = q3 = q4 = final = "";
            } else {
              q1 = scholasticData[16]; // Column Q
              q2 = scholasticData[38]; // Column AM
              q3 = scholasticData[60]; // Column BI
              q4 = scholasticData[82]; // Column CE
              final = scholasticData[104]; // Column DA
            }
            break;
          case 18:
            if (schoolYearStart > 2023 && grade < 7) {
              q1 = q2 = q3 = q4 = final = "";
            } else {
              q1 = scholasticData[17]; // Column R
              q2 = scholasticData[39]; // Column AN
              q3 = scholasticData[61]; // Column BJ
              q4 = scholasticData[83]; // Column CF
              final = scholasticData[105]; // Column DB
            }
            break;
          case 19:
            if (schoolYearStart > 2023 && grade < 7) {
              q1 = q2 = q3 = q4 = final = "";
            } else {
              q1 = scholasticData[21]; // Column V
              q2 = scholasticData[43]; // Column AR
              q3 = scholasticData[65]; // Column BN
              q4 = scholasticData[87]; // Column CJ
              final = scholasticData[109]; // Column DF
            }
            break;
          case 20:
            q1 = scholasticData[24]; // Column Y
            q2 = scholasticData[46]; // Column AU
            q3 = scholasticData[68]; // Column BQ
            q4 = scholasticData[90]; // Column CM
            final = scholasticData[112]; // Column DI
            break;
          case 21:
            q1 = scholasticData[25]; // Column Z
            q2 = scholasticData[47]; // Column AV
            q3 = scholasticData[69]; // Column BR
            q4 = scholasticData[91]; // Column CN
            final = scholasticData[113]; // Column DJ
            break;
          case 22:
            q1 = scholasticData[26]; // Column AA
            q2 = scholasticData[48]; // Column AW
            q3 = scholasticData[70]; // Column BS
            q4 = scholasticData[92]; // Column CO
            final = scholasticData[114]; // Column DK
            break;
        }

        q1 = sanitizeValue(q1);
        q2 = sanitizeValue(q2);
        q3 = sanitizeValue(q3);
        q4 = sanitizeValue(q4);
        final = sanitizeValue(final);

        // Determine remarks (column 7)
        if (final === "" || final === undefined) {
    // If final (column 5) is empty, set both final and remarks to empty
    final = "";
    remarks = "";
  } else if (rowNumber === 22) {
    // For the General Average row
    const failedCount = [7, 8, 9, 10, 11, 12, 13, 14, 18].reduce((count, row) => {
      const rowFinal = getGradeData(row, gradeValue, schoolYearValue, scholasticData, 1).final;
      return count + (rowFinal !== "" && parseFloat(rowFinal) < 75 ? 1 : 0);
    }, 0);

    if (failedCount > 2) {
      remarks = "RETAINED";
    } else if (failedCount === 0) {
      remarks = "PROMOTED";
    } else {
      remarks = "REMEDIAL";
    }
  } else {
    // For all other rows
    remarks = parseFloat(final) < 75 ? "FAILED" : "PASSED";
  }

  return { q1, q2, q3, q4, final, remarks };
      }

      function getGradeDataBox2(rowNumber, gradeValue, schoolYearValue, scholasticData) {
  console.log(`getGradeDataBox2 called with:`, { rowNumber, gradeValue, schoolYearValue });
  
  let q1 = '', q2 = '', q3 = '', q4 = '', final = '', remarks = '';

  if (!gradeValue || !schoolYearValue) {
    console.log('Box 2: No grade or school year value, returning empty result');
    return { q1, q2, q3, q4, final, remarks };
  }

  // Only proceed if both gradeValue and schoolYearValue are not empty
  if (gradeValue && schoolYearValue) {
    const schoolYearStart = parseInt(schoolYearValue.split('-')[0], 10);
    const grade = parseInt(gradeValue, 10);

    // Helper function to safely get values from scholasticData
    const safeGetValue = (index) => {
      return (scholasticData[index] !== undefined && scholasticData[index] !== null) ? scholasticData[index] : '';
    };

  switch (rowNumber) {
    case 7:
      if (grade === 1 && schoolYearStart > 2024) {
        q1 = scholasticData[148]; // Column ES
        q2 = scholasticData[170]; // Column FO
        q3 = scholasticData[192]; // Column GK
        q4 = scholasticData[214]; // Column HG
        final = scholasticData[236]; // Column IC
      } else if (grade > 1 && schoolYearStart > 2024) {
        q1 = scholasticData[134]; // Column EE
        q2 = scholasticData[156]; // Column FA
        q3 = scholasticData[178]; // Column FW
        q4 = scholasticData[200]; // Column GS
        final = scholasticData[222]; // Column HO
      } else {
        q1 = scholasticData[133]; // Column ED
        q2 = scholasticData[155]; // Column EZ
        q3 = scholasticData[177]; // Column FV
        q4 = scholasticData[199]; // Column GR
        final = scholasticData[221]; // Column HN
      }
      break;
    case 8:
      if (grade === 1 && schoolYearStart > 2024) {
        q1 = scholasticData[149]; // Column ET
        q2 = scholasticData[171]; // Column FP
        q3 = scholasticData[193]; // Column GL
        q4 = scholasticData[215]; // Column HH
        final = scholasticData[237]; // Column ID
      } else if (grade > 1 && schoolYearStart > 2024) {
        q1 = scholasticData[135]; // Column EF
        q2 = scholasticData[157]; // Column FB
        q3 = scholasticData[179]; // Column FX
        q4 = scholasticData[201]; // Column GT
        final = scholasticData[223]; // Column HP
      } else {
        q1 = scholasticData[134]; // Column EE
        q2 = scholasticData[156]; // Column FA
        q3 = scholasticData[178]; // Column FW
        q4 = scholasticData[200]; // Column GS
        final = scholasticData[222]; // Column HO
      }
      break;
    case 9:
      if (grade < 7 && schoolYearStart > 2024) {
        q1 = scholasticData[136]; // Column EG
        q2 = scholasticData[158]; // Column FC
        q3 = scholasticData[180]; // Column FY
        q4 = scholasticData[202]; // Column GU
        final = scholasticData[224]; // Column HQ
      } else {
        q1 = scholasticData[135]; // Column EF
        q2 = scholasticData[157]; // Column FB
        q3 = scholasticData[179]; // Column FX
        q4 = scholasticData[201]; // Column GT
        final = scholasticData[223]; // Column HP
      }
      break;
    case 10:
      if (schoolYearStart > 2024) {
        if (grade < 4) {
          q1 = scholasticData[132]; // Column EC
          q2 = scholasticData[154]; // Column EY
          q3 = scholasticData[176]; // Column FU
          q4 = scholasticData[198]; // Column GQ
          final = scholasticData[220]; // Column HM
        } else if (grade >= 4) {
          q1 = scholasticData[138]; // Column EI
          q2 = scholasticData[160]; // Column FE
          q3 = scholasticData[182]; // Column GA
          q4 = scholasticData[204]; // Column GW
          final = scholasticData[226]; // Column HS
        }
      } else {
        q1 = scholasticData[136]; // Column EG
        q2 = scholasticData[158]; // Column FC
        q3 = scholasticData[180]; // Column FY
        q4 = scholasticData[202]; // Column GU
        final = scholasticData[224]; // Column HQ
      }
      break;
    case 11:
      if (grade < 7 && schoolYearStart > 2024) {
        q1 = scholasticData[131]; // Column EB
        q2 = scholasticData[153]; // Column EX
        q3 = scholasticData[175]; // Column FT
        q4 = scholasticData[197]; // Column GP
        final = scholasticData[219]; // Column HL
      } else {
        q1 = scholasticData[137]; // Column EH
        q2 = scholasticData[159]; // Column FD
        q3 = scholasticData[181]; // Column FZ
        q4 = scholasticData[203]; // Column GV
        final = scholasticData[225]; // Column HR
      }
      break;
    case 12:
      if (grade < 3 && schoolYearStart > 2024) {
        q1 = q2 = q3 = q4 = final = "";
      } else if (schoolYearStart > 2023 && grade < 7) {
        q1 = scholasticData[137]; // Column EH
        q2 = scholasticData[159]; // Column FD
        q3 = scholasticData[181]; // Column FZ
        q4 = scholasticData[203]; // Column GV
        final = scholasticData[225]; // Column HR
      } else {
        q1 = scholasticData[138]; // Column EI
        q2 = scholasticData[160]; // Column FE
        q3 = scholasticData[182]; // Column GA
        q4 = scholasticData[204]; // Column GW
        final = scholasticData[226]; // Column HS
      }
      break;
    case 13:
      if (schoolYearStart > 2024 && grade < 4) {
        q1 = q2 = q3 = q4 = final = "";
      } else {
        q1 = scholasticData[139]; // Column EJ
        q2 = scholasticData[161]; // Column FF
        q3 = scholasticData[183]; // Column GB
        q4 = scholasticData[205]; // Column GX
        final = scholasticData[227]; // Column HT
      }
      break;
    case 14:
      if (schoolYearStart > 2024 && grade < 4) {
        q1 = q2 = q3 = q4 = final = "";
      } else {
        q1 = scholasticData[146]; // Column EQ
        q2 = scholasticData[168]; // Column FM
        q3 = scholasticData[190]; // Column GI
        q4 = scholasticData[212]; // Column HE
        final = scholasticData[234]; // Column IA
      }
      break;
    case 15:
      if (schoolYearStart > 2024) {
        if (grade < 4) {
          q1 = q2 = q3 = q4 = final = "";
        } else if (grade >= 4) {
          q1 = scholasticData[144]; // Column EO
          q2 = scholasticData[166]; // Column FK
          q3 = scholasticData[188]; // Column GG
          q4 = scholasticData[210]; // Column HC
          final = scholasticData[232]; // Column HY
        }
      } else {
        q1 = scholasticData[140]; // Column EK
        q2 = scholasticData[162]; // Column FG
        q3 = scholasticData[184]; // Column GC
        q4 = scholasticData[206]; // Column GY
        final = scholasticData[228]; // Column HU
      }
      break;
    case 16:
      if (schoolYearStart > 2024) {
        if (grade < 4) {
          q1 = q2 = q3 = q4 = final = "";
        } else if (grade >= 4) {
          q1 = scholasticData[145]; // Column EP
          q2 = scholasticData[167]; // Column FL
          q3 = scholasticData[189]; // Column GH
          q4 = scholasticData[211]; // Column HD
          final = scholasticData[233]; // Column HZ
        }
      } else {
        q1 = scholasticData[141]; // Column EL
        q2 = scholasticData[163]; // Column FH
        q3 = scholasticData[185]; // Column GD
        q4 = scholasticData[207]; // Column GZ
        final = scholasticData[229]; // Column HV
      }
      break;
    case 17:
      if (schoolYearStart > 2024 && grade < 7) {
        q1 = q2 = q3 = q4 = final = "";
      } else {
        q1 = scholasticData[142]; // Column EM
        q2 = scholasticData[164]; // Column FI
        q3 = scholasticData[186]; // Column GE
        q4 = scholasticData[208]; // Column HA
        final = scholasticData[230]; // Column HW
      }
      break;
    case 18:
      if (schoolYearStart > 2024 && grade < 7) {
        q1 = q2 = q3 = q4 = final = "";
      } else {
        q1 = scholasticData[143]; // Column EN
        q2 = scholasticData[165]; // Column FJ
        q3 = scholasticData[187]; // Column GF
        q4 = scholasticData[209]; // Column HB
        final = scholasticData[231]; // Column HX
      }
      break;
    case 19:
      if (schoolYearStart > 2024 && grade < 7) {
        q1 = q2 = q3 = q4 = final = "";
      } else {
        q1 = scholasticData[147]; // Column ER
        q2 = scholasticData[169]; // Column FN
        q3 = scholasticData[191]; // Column GJ
        q4 = scholasticData[213]; // Column HF
        final = scholasticData[235]; // Column IB
      }
      break;
    case 20:
      q1 = scholasticData[150]; // Column EU
      q2 = scholasticData[172]; // Column FQ
      q3 = scholasticData[194]; // Column GM
      q4 = scholasticData[216]; // Column HI
      final = scholasticData[238]; // Column IE
      break;
    case 21:
      q1 = scholasticData[151]; // Column EV
      q2 = scholasticData[173]; // Column FR
      q3 = scholasticData[195]; // Column GN
      q4 = scholasticData[217]; // Column HJ
      final = scholasticData[239]; // Column IF
      break;
    case 22:
      q1 = scholasticData[152]; // Column EW
      q2 = scholasticData[174]; // Column FS
      q3 = scholasticData[196]; // Column GO
      q4 = scholasticData[218]; // Column HK
      final = scholasticData[240]; // Column IG
      break;
  }

  console.log(`Box 2: Calculated grades:`, { q1, q2, q3, q4, final });

  // Determine remarks
  if (rowNumber === 22) {
    if (final === "") {
      remarks = "";
      console.log('Box 2: Final grade is empty, setting remarks to empty string');
    } else {
      const failedCount = [7, 8, 9, 10, 11, 12, 13, 14, 18].reduce((count, row) => {
        const rowFinal = getGradeDataBox2(row, gradeValue, schoolYearValue, scholasticData).final;
        console.log(`Box 2: Checking row ${row}, final grade: ${rowFinal}`);
        return count + (rowFinal !== "" && parseFloat(rowFinal) < 75 ? 1 : 0);
      }, 0);

      console.log(`Box 2: Failed count: ${failedCount}`);

      if (failedCount > 2) {
        remarks = "RETAINED";
      } else if (failedCount === 0) {
        remarks = "PROMOTED";
      } else {
        remarks = "REMEDIAL";
      }
      console.log(`Box 2: Set remarks to ${remarks} based on failed count`);
    }
  } else {
    remarks = final === "" ? "" : (parseFloat(final) < 75 ? "FAILED" : "PASSED");
    console.log(`Box 2: Set remarks to ${remarks} based on final grade`);
  }

  console.log(`Box 2: Final result:`, { q1, q2, q3, q4, final, remarks });
  return { q1, q2, q3, q4, final, remarks };
}
      }

function getGradeDataBox3(rowNumber, gradeValue, schoolYearValue, scholasticData) {

  console.log(`getGradeDataBox3 input: rowNumber=${rowNumber}, gradeValue=${gradeValue}, schoolYearValue=${schoolYearValue}`);
  
  // Check for empty, "NA", or "#N/A" values
  if (isEmpty(gradeValue) || isEmpty(schoolYearValue)) {
    console.log("Box 3: Empty grade or school year value detected. Returning empty result.");
    return { q1: '', q2: '', q3: '', q4: '', final: '', remarks: '' };
  }

  console.log(`scholasticData length: ${scholasticData.length}`);
  console.log(`First few elements of scholasticData: ${JSON.stringify(scholasticData.slice(0, 5))}`);

  const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
  const grade = parseInt(gradeValue, 10);

  let q1 = '', q2 = '', q3 = '', q4 = '', final = '', remarks = '';


  function getColumnIndex(letter) {
  let index = 0;
  for (let i = 0; i < letter.length; i++) {
    index = index * 26 + letter.charCodeAt(i) - 64;
  }
  return index - 1; // Subtract 1 because array indices start at 0
}

  switch (rowNumber) {
    case 7: // Mother Tongue
      if (grade === 1 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('JM')];
        q2 = scholasticData[getColumnIndex('KI')];
        q3 = scholasticData[getColumnIndex('LE')];
        q4 = scholasticData[getColumnIndex('MA')];
        final = scholasticData[getColumnIndex('MW')];
      } else if (grade > 1 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('IY')];
        q2 = scholasticData[getColumnIndex('JU')];
        q3 = scholasticData[getColumnIndex('KQ')];
        q4 = scholasticData[getColumnIndex('LM')];
        final = scholasticData[getColumnIndex('MI')];
      } else {
        q1 = scholasticData[getColumnIndex('IX')];
        q2 = scholasticData[getColumnIndex('JT')];
        q3 = scholasticData[getColumnIndex('KP')];
        q4 = scholasticData[getColumnIndex('LL')];
        final = scholasticData[getColumnIndex('MH')];
      }
      break;
    case 8: // Filipino
      if (grade === 1 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('JN')];
        q2 = scholasticData[getColumnIndex('KJ')];
        q3 = scholasticData[getColumnIndex('LF')];
        q4 = scholasticData[getColumnIndex('MB')];
        final = scholasticData[getColumnIndex('MX')];
      } else if (grade > 1 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('IZ')];
        q2 = scholasticData[getColumnIndex('JV')];
        q3 = scholasticData[getColumnIndex('KR')];
        q4 = scholasticData[getColumnIndex('LN')];
        final = scholasticData[getColumnIndex('MJ')];
      } else {
        q1 = scholasticData[getColumnIndex('IY')];
        q2 = scholasticData[getColumnIndex('JU')];
        q3 = scholasticData[getColumnIndex('KQ')];
        q4 = scholasticData[getColumnIndex('LM')];
        final = scholasticData[getColumnIndex('MI')];
      }
      break;
    case 9: // English
      if (grade < 7 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('JA')];
        q2 = scholasticData[getColumnIndex('JW')];
        q3 = scholasticData[getColumnIndex('KS')];
        q4 = scholasticData[getColumnIndex('LO')];
        final = scholasticData[getColumnIndex('MK')];
      } else {
        q1 = scholasticData[getColumnIndex('IZ')];
        q2 = scholasticData[getColumnIndex('JV')];
        q3 = scholasticData[getColumnIndex('KR')];
        q4 = scholasticData[getColumnIndex('LN')];
        final = scholasticData[getColumnIndex('MJ')];
      }
      break;
    case 10: // Mathematics
      if (schoolYearStart > 2023) {
        if (grade < 4) {
          q1 = scholasticData[getColumnIndex('IW')];
          q2 = scholasticData[getColumnIndex('JS')];
          q3 = scholasticData[getColumnIndex('KO')];
          q4 = scholasticData[getColumnIndex('LK')];
          final = scholasticData[getColumnIndex('MG')];
        } else if (grade >= 4) {
          q1 = scholasticData[getColumnIndex('JC')];
          q2 = scholasticData[getColumnIndex('JY')];
          q3 = scholasticData[getColumnIndex('KU')];
          q4 = scholasticData[getColumnIndex('LQ')];
          final = scholasticData[getColumnIndex('MM')];
        }
      } else {
        q1 = scholasticData[getColumnIndex('JA')];
        q2 = scholasticData[getColumnIndex('JW')];
        q3 = scholasticData[getColumnIndex('KS')];
        q4 = scholasticData[getColumnIndex('LO')];
        final = scholasticData[getColumnIndex('MK')];
      }
      break;
    case 11: // Science
      if (grade < 7 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('IV')];
        q2 = scholasticData[getColumnIndex('JR')];
        q3 = scholasticData[getColumnIndex('KN')];
        q4 = scholasticData[getColumnIndex('LJ')];
        final = scholasticData[getColumnIndex('MF')];
      } else {
        q1 = scholasticData[getColumnIndex('JB')];
        q2 = scholasticData[getColumnIndex('JX')];
        q3 = scholasticData[getColumnIndex('KT')];
        q4 = scholasticData[getColumnIndex('LP')];
        final = scholasticData[getColumnIndex('ML')];
      }
      break;
    case 12: // Araling Panlipunan
      if (grade < 3 && schoolYearStart > 2023) {
        q1 = q2 = q3 = q4 = final = "";
      } else if (schoolYearStart > 2023 && grade < 7) {
        q1 = scholasticData[getColumnIndex('JB')];
        q2 = scholasticData[getColumnIndex('JX')];
        q3 = scholasticData[getColumnIndex('KT')];
        q4 = scholasticData[getColumnIndex('LP')];
        final = scholasticData[getColumnIndex('ML')];
      } else {
        q1 = scholasticData[getColumnIndex('JC')];
        q2 = scholasticData[getColumnIndex('JY')];
        q3 = scholasticData[getColumnIndex('KU')];
        q4 = scholasticData[getColumnIndex('LQ')];
        final = scholasticData[getColumnIndex('MM')];
      }
      break;
    case 13: // EPP/TLE
      if (schoolYearStart > 2023 && grade < 4) {
        q1 = q2 = q3 = q4 = final = "";
      } else {
        q1 = scholasticData[getColumnIndex('JD')];
        q2 = scholasticData[getColumnIndex('JZ')];
        q3 = scholasticData[getColumnIndex('KV')];
        q4 = scholasticData[getColumnIndex('LR')];
        final = scholasticData[getColumnIndex('MN')];
      }
      break;
    case 14: // MAPEH
      if (schoolYearStart > 2023 && grade < 4) {
        q1 = q2 = q3 = q4 = final = "";
      } else {
        q1 = scholasticData[getColumnIndex('JK')];
        q2 = scholasticData[getColumnIndex('KG')];
        q3 = scholasticData[getColumnIndex('LC')];
        q4 = scholasticData[getColumnIndex('LY')];
        final = scholasticData[getColumnIndex('MU')];
      }
      break;
    case 15: // Music
      if (schoolYearStart > 2023) {
        if (grade < 4) {
          q1 = q2 = q3 = q4 = final = "";
        } else if (grade >= 4) {
          q1 = scholasticData[getColumnIndex('JI')];
          q2 = scholasticData[getColumnIndex('KE')];
          q3 = scholasticData[getColumnIndex('LA')];
          q4 = scholasticData[getColumnIndex('LW')];
          final = scholasticData[getColumnIndex('MS')];
        }
      } else {
        q1 = scholasticData[getColumnIndex('JE')];
        q2 = scholasticData[getColumnIndex('KA')];
        q3 = scholasticData[getColumnIndex('KW')];
        q4 = scholasticData[getColumnIndex('LS')];
        final = scholasticData[getColumnIndex('MO')];
      }
      break;
    case 16: // Arts
      if (schoolYearStart > 2023) {
        if (grade < 4) {
          q1 = q2 = q3 = q4 = final = "";
        } else if (grade >= 4) {
          q1 = scholasticData[getColumnIndex('JJ')];
          q2 = scholasticData[getColumnIndex('KF')];
          q3 = scholasticData[getColumnIndex('LB')];
          q4 = scholasticData[getColumnIndex('LX')];
          final = scholasticData[getColumnIndex('MT')];
        }
      } else {
        q1 = scholasticData[getColumnIndex('JF')];
        q2 = scholasticData[getColumnIndex('KB')];
        q3 = scholasticData[getColumnIndex('KX')];
        q4 = scholasticData[getColumnIndex('LT')];
        final = scholasticData[getColumnIndex('MP')];
      }
      break;
    case 17: // Physical Education
      if (schoolYearStart > 2023 && grade < 7) {
        q1 = q2 = q3 = q4 = final = "";
      } else {
        q1 = scholasticData[getColumnIndex('JG')];
        q2 = scholasticData[getColumnIndex('KC')];
        q3 = scholasticData[getColumnIndex('KY')];
        q4 = scholasticData[getColumnIndex('LU')];
        final = scholasticData[getColumnIndex('MQ')];
      }
      break;
    case 18: // Health
      if (schoolYearStart > 2023 && grade < 7) {
        q1 = q2 = q3 = q4 = final = "";
      } else {
        q1 = scholasticData[getColumnIndex('JH')];
        q2 = scholasticData[getColumnIndex('KD')];
        q3 = scholasticData[getColumnIndex('KZ')];
        q4 = scholasticData[getColumnIndex('LV')];
        final = scholasticData[getColumnIndex('MR')];
      }
      break;
    case 19: // Edukasyon sa Pagpapakatao
      if (schoolYearStart > 2023 && grade < 7) {
        q1 = q2 = q3 = q4 = final = "";
      } else {
        q1 = scholasticData[getColumnIndex('JL')];
        q2 = scholasticData[getColumnIndex('KH')];
        q3 = scholasticData[getColumnIndex('LD')];
        q4 = scholasticData[getColumnIndex('LZ')];
        final = scholasticData[getColumnIndex('MV')];
      }
      break;
    case 20: // Arabic Language or Islamic Values Education
      if (getSubjectText(20, gradeValue, schoolYearValue).includes("Arabic Language")) {
        q1 = scholasticData[getColumnIndex('JO')];
        q2 = scholasticData[getColumnIndex('KK')];
        q3 = scholasticData[getColumnIndex('LG')];
        q4 = scholasticData[getColumnIndex('MC')];
        final = scholasticData[getColumnIndex('MY')];
      } else if (getSubjectText(20, gradeValue, schoolYearValue).includes("Islamic Values Education")) {
        q1 = scholasticData[getColumnIndex('JP')];
        q2 = scholasticData[getColumnIndex('KL')];
        q3 = scholasticData[getColumnIndex('LH')];
        q4 = scholasticData[getColumnIndex('MD')];
        final = scholasticData[getColumnIndex('MZ')];
      }
      break;
    case 21: // Islamic Values Education (if not in row 20)
      if (getSubjectText(21, gradeValue, schoolYearValue).includes("Islamic Values Education")) {
        q1 = scholasticData[getColumnIndex('JP')];
        q2 = scholasticData[getColumnIndex('KL')];
        q3 = scholasticData[getColumnIndex('LH')];
        q4 = scholasticData[getColumnIndex('MD')];
        final = scholasticData[getColumnIndex('MZ')];
      }
      break;
    case 22: // General Average
      q1 = scholasticData[getColumnIndex('JQ')];
      q2 = scholasticData[getColumnIndex('KM')];
      q3 = scholasticData[getColumnIndex('LI')];
      q4 = scholasticData[getColumnIndex('ME')];
      final = scholasticData[getColumnIndex('NA')];
      break;
  }

    // Determine remarks
if (rowNumber === 22) {
  if (final === "") {
    remarks = "";
  } else {
    const failedCount = [7, 8, 9, 10, 11, 12, 13, 14, 18].reduce((count, row) => {
      const rowFinal = getGradeDataBox3(row, gradeValue, schoolYearValue, scholasticData).final;
      return count + (rowFinal !== "" && parseFloat(rowFinal) < 75 ? 1 : 0);
    }, 0);

    if (failedCount > 2) {
      remarks = "RETAINED";
    } else if (failedCount === 0) {
      remarks = "PROMOTED";
    } else {
      remarks = "REMEDIAL";
    }
  }
} else {
  remarks = final === "" ? "" : (parseFloat(final) < 75 ? "FAILED" : "PASSED");
}

return { q1, q2, q3, q4, final, remarks };
}

function getGradeDataBox4(rowNumber, gradeValue, schoolYearValue, scholasticData) {
  console.log(`getGradeDataBox4 input: rowNumber=${rowNumber}, gradeValue=${gradeValue}, schoolYearValue=${schoolYearValue}`);
  
  // Check for empty, "NA", or "#N/A" values
  if (isEmpty(gradeValue) || isEmpty(schoolYearValue)) {
    console.log("Box 4: Empty grade or school year value detected. Returning empty result.");
    return { q1: '', q2: '', q3: '', q4: '', final: '', remarks: '' };
  }

  console.log(`scholasticData length: ${scholasticData.length}`);
  console.log(`First few elements of scholasticData: ${JSON.stringify(scholasticData.slice(0, 5))}`);

  const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
  const grade = parseInt(gradeValue, 10);
  const sanitizeValue = (value) => (value === undefined || value === null || value === '') ? '' : value;

  

  let q1 = '', q2 = '', q3 = '', q4 = '', final = '', remarks = '';


  function getColumnIndex(letter) {
    let index = 0;
    for (let i = 0; i < letter.length; i++) {
      index = index * 26 + letter.charCodeAt(i) - 64;
    }
    return index - 1;
  }

  try {
    switch (rowNumber) {
      case 7:
        if (grade === 1 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('OG')];
          q2 = scholasticData[getColumnIndex('PC')];
          q3 = scholasticData[getColumnIndex('PY')];
          q4 = scholasticData[getColumnIndex('QU')];
          final = scholasticData[getColumnIndex('RQ')];
        } else if (grade > 1 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('NS')];
          q2 = scholasticData[getColumnIndex('OO')];
          q3 = scholasticData[getColumnIndex('PK')];
          q4 = scholasticData[getColumnIndex('QG')];
          final = scholasticData[getColumnIndex('RC')];
        } else {
          q1 = scholasticData[getColumnIndex('NR')];
          q2 = scholasticData[getColumnIndex('ON')];
          q3 = scholasticData[getColumnIndex('PJ')];
          q4 = scholasticData[getColumnIndex('QF')];
          final = scholasticData[getColumnIndex('RB')];
        }
        break;
      case 8:
        if (grade === 1 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('OH')];
          q2 = scholasticData[getColumnIndex('PD')];
          q3 = scholasticData[getColumnIndex('PZ')];
          q4 = scholasticData[getColumnIndex('QV')];
          final = scholasticData[getColumnIndex('RR')];
        } else if (grade > 1 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('NT')];
          q2 = scholasticData[getColumnIndex('OP')];
          q3 = scholasticData[getColumnIndex('PL')];
          q4 = scholasticData[getColumnIndex('QH')];
          final = scholasticData[getColumnIndex('RD')];
        } else {
          q1 = scholasticData[getColumnIndex('NS')];
          q2 = scholasticData[getColumnIndex('OO')];
          q3 = scholasticData[getColumnIndex('PK')];
          q4 = scholasticData[getColumnIndex('QG')];
          final = scholasticData[getColumnIndex('RC')];
        }
        break;
      case 9:
        if (grade < 7 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('NU')];
          q2 = scholasticData[getColumnIndex('OQ')];
          q3 = scholasticData[getColumnIndex('PM')];
          q4 = scholasticData[getColumnIndex('QI')];
          final = scholasticData[getColumnIndex('RE')];
        } else {
          q1 = scholasticData[getColumnIndex('NT')];
          q2 = scholasticData[getColumnIndex('OP')];
          q3 = scholasticData[getColumnIndex('PL')];
          q4 = scholasticData[getColumnIndex('QH')];
          final = scholasticData[getColumnIndex('RD')];
        }
        break;
      case 10:
        if (schoolYearStart > 2023) {
          if (grade < 4) {
            q1 = scholasticData[getColumnIndex('NQ')];
            q2 = scholasticData[getColumnIndex('OM')];
            q3 = scholasticData[getColumnIndex('PI')];
            q4 = scholasticData[getColumnIndex('QE')];
            final = scholasticData[getColumnIndex('RA')];
          } else if (grade >= 4) {
            q1 = scholasticData[getColumnIndex('NW')];
            q2 = scholasticData[getColumnIndex('OS')];
            q3 = scholasticData[getColumnIndex('PO')];
            q4 = scholasticData[getColumnIndex('QK')];
            final = scholasticData[getColumnIndex('RG')];
          }
        } else {
          q1 = scholasticData[getColumnIndex('NU')];
          q2 = scholasticData[getColumnIndex('OQ')];
          q3 = scholasticData[getColumnIndex('PM')];
          q4 = scholasticData[getColumnIndex('QI')];
          final = scholasticData[getColumnIndex('RE')];
        }
        break;
      case 11:
        if (grade < 7 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('NP')];
          q2 = scholasticData[getColumnIndex('OL')];
          q3 = scholasticData[getColumnIndex('PH')];
          q4 = scholasticData[getColumnIndex('QD')];
          final = scholasticData[getColumnIndex('QZ')];
        } else {
          q1 = scholasticData[getColumnIndex('NV')];
          q2 = scholasticData[getColumnIndex('OR')];
          q3 = scholasticData[getColumnIndex('PN')];
          q4 = scholasticData[getColumnIndex('QJ')];
          final = scholasticData[getColumnIndex('RF')];
        }
        break;
      case 12:
        if (grade < 3 && schoolYearStart > 2023) {
          q1 = q2 = q3 = q4 = final = "";
        } else if (schoolYearStart > 2023 && grade < 7) {
          q1 = scholasticData[getColumnIndex('NV')];
          q2 = scholasticData[getColumnIndex('OR')];
          q3 = scholasticData[getColumnIndex('PN')];
          q4 = scholasticData[getColumnIndex('QJ')];
          final = scholasticData[getColumnIndex('RF')];
        } else {
          q1 = scholasticData[getColumnIndex('NW')];
          q2 = scholasticData[getColumnIndex('OS')];
          q3 = scholasticData[getColumnIndex('PO')];
          q4 = scholasticData[getColumnIndex('QK')];
          final = scholasticData[getColumnIndex('RG')];
        }
        break;
      case 13:
        if (schoolYearStart > 2023 && grade < 4) {
          q1 = q2 = q3 = q4 = final = "";
        } else {
          q1 = scholasticData[getColumnIndex('NX')];
          q2 = scholasticData[getColumnIndex('OT')];
          q3 = scholasticData[getColumnIndex('PP')];
          q4 = scholasticData[getColumnIndex('QL')];
          final = scholasticData[getColumnIndex('RH')];
        }
        break;
      case 14:
        if (schoolYearStart > 2023 && grade < 4) {
          q1 = q2 = q3 = q4 = final = "";
        } else {
          q1 = scholasticData[getColumnIndex('OE')];
          q2 = scholasticData[getColumnIndex('PA')];
          q3 = scholasticData[getColumnIndex('PW')];
          q4 = scholasticData[getColumnIndex('QS')];
          final = scholasticData[getColumnIndex('RO')];
        }
        break;
      case 15:
        if (schoolYearStart > 2023) {
          if (grade < 4) {
            q1 = q2 = q3 = q4 = final = "";
          } else if (grade >= 4) {
            q1 = scholasticData[getColumnIndex('OC')];
            q2 = scholasticData[getColumnIndex('OY')];
            q3 = scholasticData[getColumnIndex('PU')];
            q4 = scholasticData[getColumnIndex('QQ')];
            final = scholasticData[getColumnIndex('RM')];
          }
        } else {
          q1 = scholasticData[getColumnIndex('NY')];
          q2 = scholasticData[getColumnIndex('OU')];
          q3 = scholasticData[getColumnIndex('PQ')];
          q4 = scholasticData[getColumnIndex('QM')];
          final = scholasticData[getColumnIndex('RI')];
        }
        break;
      case 16:
        if (schoolYearStart > 2023) {
          if (grade < 4) {
            q1 = q2 = q3 = q4 = final = "";
          } else if (grade >= 4) {
            q1 = scholasticData[getColumnIndex('OD')];
            q2 = scholasticData[getColumnIndex('OZ')];
            q3 = scholasticData[getColumnIndex('PV')];
            q4 = scholasticData[getColumnIndex('QR')];
            final = scholasticData[getColumnIndex('RN')];
          }
        } else {
          q1 = scholasticData[getColumnIndex('NZ')];
          q2 = scholasticData[getColumnIndex('OV')];
          q3 = scholasticData[getColumnIndex('PR')];
          q4 = scholasticData[getColumnIndex('QN')];
          final = scholasticData[getColumnIndex('RJ')];
        }
        break;
      case 17:
        if (schoolYearStart > 2023 && grade < 7) {
          q1 = q2 = q3 = q4 = final = "";
        } else {
          q1 = scholasticData[getColumnIndex('OA')];
          q2 = scholasticData[getColumnIndex('OW')];
          q3 = scholasticData[getColumnIndex('PS')];
          q4 = scholasticData[getColumnIndex('QO')];
          final = scholasticData[getColumnIndex('RK')];
        }
        break;
      case 18:
        if (schoolYearStart > 2023 && grade < 7) {
          q1 = q2 = q3 = q4 = final = "";
        } else {
          q1 = scholasticData[getColumnIndex('OB')];
          q2 = scholasticData[getColumnIndex('OX')];
          q3 = scholasticData[getColumnIndex('PT')];
          q4 = scholasticData[getColumnIndex('QP')];
          final = scholasticData[getColumnIndex('RL')];
        }
        break;
      case 19:
        if (schoolYearStart > 2023 && grade < 7) {
          q1 = q2 = q3 = q4 = final = "";
        } else {
          q1 = scholasticData[getColumnIndex('OF')];
          q2 = scholasticData[getColumnIndex('PB')];
          q3 = scholasticData[getColumnIndex('PX')];
          q4 = scholasticData[getColumnIndex('QT')];
          final = scholasticData[getColumnIndex('RP')];
        }
        break;
      case 20:
        if (getSubjectText(20, gradeValue, schoolYearValue).includes("Arabic Language")) {
          q1 = scholasticData[getColumnIndex('OI')];
          q2 = scholasticData[getColumnIndex('PE')];
          q3 = scholasticData[getColumnIndex('QA')];
          q4 = scholasticData[getColumnIndex('QW')];
          final = scholasticData[getColumnIndex('RS')];
        } else if (getSubjectText(20, gradeValue, schoolYearValue).includes("Islamic Values Education")) {
          q1 = scholasticData[getColumnIndex('OJ')];
          q2 = scholasticData[getColumnIndex('PF')];
          q3 = scholasticData[getColumnIndex('QB')];
          q4 = scholasticData[getColumnIndex('QX')];
          final = scholasticData[getColumnIndex('RT')];
        }
        break;
      case 21:
        if (getSubjectText(21, gradeValue, schoolYearValue).includes("Islamic Values Education")) {
          q1 = scholasticData[getColumnIndex('OJ')];
          q2 = scholasticData[getColumnIndex('PF')];
          q3 = scholasticData[getColumnIndex('QB')];
          q4 = scholasticData[getColumnIndex('QX')];
          final = scholasticData[getColumnIndex('RT')];
        }
        break;
      case 22:
        q1 = scholasticData[getColumnIndex('OK')];
        q2 = scholasticData[getColumnIndex('PG')];
        q3 = scholasticData[getColumnIndex('QC')];
        q4 = scholasticData[getColumnIndex('QY')];
        final = scholasticData[getColumnIndex('RU')];
        break;
    }

    q1 = sanitizeValue(q1);
  q2 = sanitizeValue(q2);
  q3 = sanitizeValue(q3);
  q4 = sanitizeValue(q4);
  final = sanitizeValue(final);

  // Determine remarks (column 7)
  if (final === "") {
    remarks = "";
  } else
    if (rowNumber === 22) {
      if (final === "") {
        remarks = "";
      } else {
        const failedCount = [7, 8, 9, 10, 11, 12, 13, 14, 18].reduce((count, row) => {
          const rowFinal = getGradeDataBox4(row, gradeValue, schoolYearValue, scholasticData).final;
          return count + (rowFinal !== "" && parseFloat(rowFinal) < 75 ? 1 : 0);
        }, 0);

        if (failedCount > 2) {
          remarks = "RETAINED";
        } else if (failedCount === 0) {
          remarks = "PROMOTED";
        } else {
          remarks = "REMEDIAL";
        }
      }
    } else {
      remarks = final === "" ? "" : (parseFloat(final) < 75 ? "FAILED" : "PASSED");
    }

    console.log(`Retrieved values for row ${rowNumber}: q1=${q1}, q2=${q2}, q3=${q3}, q4=${q4}, final=${final}, remarks=${remarks}`);

    return { q1, q2, q3, q4, final, remarks };
  } catch (error) {
    console.error(`Error in getGradeDataBox4 for row ${rowNumber}:`, error);
    return { q1: '', q2: '', q3: '', q4: '', final: '', remarks: '' };
  }
}
        

function createBox2(profileData, scholasticData) {
  const gradeValue = profileData[34]; // AI for Box 2
  const schoolYearValue = profileData[32]; // AG for Box 2
  const signatureValue = profileData[103]; // Column CT for Box 2 signature

  console.log(`Box 2 - Grade: ${gradeValue}, School Year: ${schoolYearValue}`);

  let gradesSection = `
    <!-- Grades Section Header (Rows 5 and 6) -->
    <tr class="grades-header-row">
      <td colspan="9" rowspan="2" class="grades-area-label">LEARNING AREAS</td>
      <td colspan="4" class="grades-quarter-label">Quarterly Rating</td>
      <td colspan="3" rowspan="2" class="grades-final-label">Final<br>Rating</td>
      <td colspan="3" rowspan="2" class="grades-remarks-label">Remarks</td>
    </tr>
    <tr class="grades-header-row">
      <td class="grades-quarter-num">1</td>
      <td class="grades-quarter-num">2</td>
      <td class="grades-quarter-num">3</td>
      <td class="grades-quarter-num">4</td>
    </tr>
  `;

  // Add rows 7 to 22 with merged cells in the first column
  for (let i = 7; i <= 22; i++) {
    let subjectText = getSubjectText(i, gradeValue, schoolYearValue);
    let cellClass = 'subject-cell';
    
    if ((i >= 7 && i <= 14) || i === 19 || i === 22) {
      cellClass += ' subject-cell-bold';
    } else if ((i >= 15 && i <= 18) || i === 20 || i === 21) {
      cellClass += ' subject-cell-italic';
    }

    const gradeData = getGradeDataBox2(i, gradeValue, schoolYearValue, scholasticData);

    gradesSection += `
      <tr class="grades-data-row">
        <td colspan="9" class="${cellClass}" style="white-space: pre-wrap;">${subjectText}</td>
        <td class="grade-cell">${gradeData.q1}</td>
        <td class="grade-cell">${gradeData.q2}</td>
        <td class="grade-cell">${gradeData.q3}</td>
        <td class="grade-cell">${gradeData.q4}</td>
        <td colspan="3" class="final-grade-cell">${gradeData.final}</td>
        <td colspan="3" class="remarks-cell">${gradeData.remarks}</td>
      </tr>
    `;
  }

  return `
    <table class="box">
      <tr>
        <td colspan="14">
          <span class="label" id="box2-school-label">School:</span>
          ${displayValue(profileData[40], 180)}
        </td>
        <td colspan="5" class="school-id-container">
          <span class="label" id="box2-school-id-label">School ID:</span>
          ${displayValue(profileData[39], 35)}
        </td>
      </tr>
      <tr>
        <td colspan="8">
          <span class="label" id="box2-district-label">District:</span>
          ${displayValue(profileData[38], 95)}
        </td>
        <td colspan="8">
          <span class="label" id="box2-division-label">Division:</span>
          ${displayValue(profileData[37], 97)}
        </td>
        <td colspan="3" class="region-container">
          <span class="label" id="box2-region-label">Region:</span>
          ${displayValue(profileData[36], 15)}
        </td>
      </tr>
      <tr>
        <td colspan="6" style="width: 31.5%;">
          <span class="label" id="box2-grade-label">Classified as Grade:</span>
          ${displayValue(profileData[34], 56)}
        </td>
        <td colspan="8" style="width: 42%;">
          <span class="label" id="box2-section-label">Section:</span>
          ${displayValue(profileData[35], 70)}
        </td>
        <td colspan="5" style="width: 26.5%;" class="school-year-container">
          <span class="label" id="box2-school-year-label">School Year:</span>
          ${displayValue(profileData[32], 42, true)}
        </td>
      </tr>
      <tr>
        <td colspan="13">
          <span class="label" id="box2-adviser-label">Name of Adviser/Teacher:</span>
          ${displayValue(profileData[33], 150)}
        </td>
        <td colspan="2">
          <span class="label" id="box2-signature-label">Signature:</span>
        </td>
        <td colspan="4">
          ${displaySignature(signatureValue, 100)}
        </td>
      </tr>
      ${gradesSection}
    </table>
  `;
}

function getGradeDataBox5(rowNumber, gradeValue, schoolYearValue, scholasticData) {
  console.log(`getGradeDataBox5 input: rowNumber=${rowNumber}, gradeValue=${gradeValue}, schoolYearValue=${schoolYearValue}`);
  
  if (isEmpty(gradeValue) || isEmpty(schoolYearValue)) {
    console.log("Box 5: Empty grade or school year value detected. Returning empty result.");
    return { q1: '', q2: '', q3: '', q4: '', final: '', remarks: '' };
  }

  const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
  const grade = parseInt(gradeValue, 10);
const sanitizeValue = (value) => (value === undefined || value === null || value === '') ? '' : value;


  let q1 = '', q2 = '', q3 = '', q4 = '', final = '', remarks = '';

  function getColumnIndex(letter) {
    let index = 0;
    for (let i = 0; i < letter.length; i++) {
      index = index * 26 + letter.charCodeAt(i) - 64;
    }
    return index - 1;
  }

  try {
    switch (rowNumber) {
      case 7: // Mother Tongue
        if (grade === 1 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('TA')];
          q2 = scholasticData[getColumnIndex('TW')];
          q3 = scholasticData[getColumnIndex('US')];
          q4 = scholasticData[getColumnIndex('VO')];
          final = scholasticData[getColumnIndex('WK')];
        } else if (grade > 1 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('SM')];
          q2 = scholasticData[getColumnIndex('TI')];
          q3 = scholasticData[getColumnIndex('UE')];
          q4 = scholasticData[getColumnIndex('VA')];
          final = scholasticData[getColumnIndex('VW')];
        } else {
          q1 = scholasticData[getColumnIndex('SL')];
          q2 = scholasticData[getColumnIndex('TH')];
          q3 = scholasticData[getColumnIndex('UD')];
          q4 = scholasticData[getColumnIndex('UZ')];
          final = scholasticData[getColumnIndex('VV')];
        }
        break;
      case 8: // Filipino
        if (grade === 1 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('TB')];
          q2 = scholasticData[getColumnIndex('TX')];
          q3 = scholasticData[getColumnIndex('UT')];
          q4 = scholasticData[getColumnIndex('VP')];
          final = scholasticData[getColumnIndex('WL')];
        } else if (grade > 1 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('SN')];
          q2 = scholasticData[getColumnIndex('TJ')];
          q3 = scholasticData[getColumnIndex('UF')];
          q4 = scholasticData[getColumnIndex('VB')];
          final = scholasticData[getColumnIndex('VX')];
        } else {
          q1 = scholasticData[getColumnIndex('SM')];
          q2 = scholasticData[getColumnIndex('TI')];
          q3 = scholasticData[getColumnIndex('UE')];
          q4 = scholasticData[getColumnIndex('VA')];
          final = scholasticData[getColumnIndex('VW')];
        }
        break;
      case 9: // English
        if (grade < 7 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('SO')];
          q2 = scholasticData[getColumnIndex('TK')];
          q3 = scholasticData[getColumnIndex('UG')];
          q4 = scholasticData[getColumnIndex('VC')];
          final = scholasticData[getColumnIndex('VY')];
        } else {
          q1 = scholasticData[getColumnIndex('SN')];
          q2 = scholasticData[getColumnIndex('TJ')];
          q3 = scholasticData[getColumnIndex('UF')];
          q4 = scholasticData[getColumnIndex('VB')];
          final = scholasticData[getColumnIndex('VX')];
        }
        break;
      case 10: // Mathematics
        if (schoolYearStart > 2023) {
          if (grade < 4) {
            q1 = scholasticData[getColumnIndex('SK')];
            q2 = scholasticData[getColumnIndex('TG')];
            q3 = scholasticData[getColumnIndex('UC')];
            q4 = scholasticData[getColumnIndex('UY')];
            final = scholasticData[getColumnIndex('VU')];
          } else if (grade >= 4) {
            q1 = scholasticData[getColumnIndex('SQ')];
            q2 = scholasticData[getColumnIndex('TM')];
            q3 = scholasticData[getColumnIndex('UI')];
            q4 = scholasticData[getColumnIndex('VE')];
            final = scholasticData[getColumnIndex('WA')];
          }
        } else {
          q1 = scholasticData[getColumnIndex('SO')];
          q2 = scholasticData[getColumnIndex('TK')];
          q3 = scholasticData[getColumnIndex('UG')];
          q4 = scholasticData[getColumnIndex('VC')];
          final = scholasticData[getColumnIndex('VY')];
        }
        break;
      case 11: // Science
        if (grade < 7 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('SJ')];
          q2 = scholasticData[getColumnIndex('TF')];
          q3 = scholasticData[getColumnIndex('UB')];
          q4 = scholasticData[getColumnIndex('UX')];
          final = scholasticData[getColumnIndex('VT')];
        } else {
          q1 = scholasticData[getColumnIndex('SP')];
          q2 = scholasticData[getColumnIndex('TL')];
          q3 = scholasticData[getColumnIndex('UH')];
          q4 = scholasticData[getColumnIndex('VD')];
          final = scholasticData[getColumnIndex('VZ')];
        }
        break;
      case 12: // Araling Panlipunan (AP)
        if (grade < 3 && schoolYearStart > 2023) {
          // Empty string for grades 1-2 after 2023
        } else if (schoolYearStart > 2023 && grade < 7) {
          q1 = scholasticData[getColumnIndex('SP')];
          q2 = scholasticData[getColumnIndex('TL')];
          q3 = scholasticData[getColumnIndex('UH')];
          q4 = scholasticData[getColumnIndex('VD')];
          final = scholasticData[getColumnIndex('VZ')];
        } else {
          q1 = scholasticData[getColumnIndex('SQ')];
          q2 = scholasticData[getColumnIndex('TM')];
          q3 = scholasticData[getColumnIndex('UI')];
          q4 = scholasticData[getColumnIndex('VE')];
          final = scholasticData[getColumnIndex('WA')];
        }
        break;
      case 13: // Edukasyon sa Pagpapakatao (EsP)
        if (schoolYearStart > 2023 && grade < 4) {
          // Empty string for grades 1-3 after 2023
        } else {
          q1 = scholasticData[getColumnIndex('SR')];
          q2 = scholasticData[getColumnIndex('TN')];
          q3 = scholasticData[getColumnIndex('UJ')];
          q4 = scholasticData[getColumnIndex('VF')];
          final = scholasticData[getColumnIndex('WB')];
        }
        break;
      case 14: // Music
        if (schoolYearStart > 2023 && grade < 4) {
          // Empty string for grades 1-3 after 2023
        } else {
          q1 = scholasticData[getColumnIndex('SY')];
          q2 = scholasticData[getColumnIndex('TU')];
          q3 = scholasticData[getColumnIndex('UQ')];
          q4 = scholasticData[getColumnIndex('VM')];
          final = scholasticData[getColumnIndex('WI')];
        }
        break;
      case 15: // Arts
        if (schoolYearStart > 2023) {
          if (grade < 4) {
            // Empty string for grades 1-3 after 2023
          } else if (grade >= 4) {
            q1 = scholasticData[getColumnIndex('SW')];
            q2 = scholasticData[getColumnIndex('TS')];
            q3 = scholasticData[getColumnIndex('UO')];
            q4 = scholasticData[getColumnIndex('VK')];
            final = scholasticData[getColumnIndex('WG')];
          }
        } else {
          q1 = scholasticData[getColumnIndex('SS')];
          q2 = scholasticData[getColumnIndex('TO')];
          q3 = scholasticData[getColumnIndex('UK')];
          q4 = scholasticData[getColumnIndex('VG')];
          final = scholasticData[getColumnIndex('WC')];
        }
        break;
      case 16: // Physical Education
        if (schoolYearStart > 2023) {
          if (grade < 4) {
            // Empty string for grades 1-3 after 2023
          } else if (grade >= 4) {
            q1 = scholasticData[getColumnIndex('SX')];
            q2 = scholasticData[getColumnIndex('TT')];
            q3 = scholasticData[getColumnIndex('UP')];
            q4 = scholasticData[getColumnIndex('VL')];
            final = scholasticData[getColumnIndex('WH')];
          }
        } else {
          q1 = scholasticData[getColumnIndex('ST')];
          q2 = scholasticData[getColumnIndex('TP')];
          q3 = scholasticData[getColumnIndex('UL')];
          q4 = scholasticData[getColumnIndex('VH')];
          final = scholasticData[getColumnIndex('WD')];
        }
        break;
      case 17: // Health
        if (schoolYearStart > 2023 && grade < 7) {
          // Empty string for grades 1-6 after 2023
        } else {
          q1 = scholasticData[getColumnIndex('SU')];
          q2 = scholasticData[getColumnIndex('TQ')];
          q3 = scholasticData[getColumnIndex('UM')];
          q4 = scholasticData[getColumnIndex('VI')];
          final = scholasticData[getColumnIndex('WE')];
        }
        break;
      case 18: // Edukasyong Pantahanan at Pangkabuhayan (EPP) / Technology and Livelihood Education (TLE)
        if (schoolYearStart > 2023 && grade < 7) {
          // Empty string for grades 1-6 after 2023
        } else {
          q1 = scholasticData[getColumnIndex('SV')];
          q2 = scholasticData[getColumnIndex('TR')];
          q3 = scholasticData[getColumnIndex('UN')];
          q4 = scholasticData[getColumnIndex('VJ')];
          final = scholasticData[getColumnIndex('WF')];
        }
        break;
      case 19: // MAPEH
        if (schoolYearStart > 2023 && grade < 7) {
          // Empty string for grades 1-6 after 2023
        } else {
          q1 = scholasticData[getColumnIndex('SZ')];
          q2 = scholasticData[getColumnIndex('TV')];
          q3 = scholasticData[getColumnIndex('UR')];
          q4 = scholasticData[getColumnIndex('VN')];
          final = scholasticData[getColumnIndex('WJ')];
        }
        break;
      case 20: // Arabic Language / Islamic Values
        if (getSubjectText(20, gradeValue, schoolYearValue).includes("Arabic Language")) {
          q1 = scholasticData[getColumnIndex('TC')];
          q2 = scholasticData[getColumnIndex('TY')];
          q3 = scholasticData[getColumnIndex('UU')];
          q4 = scholasticData[getColumnIndex('VQ')];
          final = scholasticData[getColumnIndex('WM')];
        } else if (getSubjectText(20, gradeValue, schoolYearValue).includes("Islamic Values Education")) {
          q1 = scholasticData[getColumnIndex('TD')];
          q2 = scholasticData[getColumnIndex('TZ')];
          q3 = scholasticData[getColumnIndex('UV')];
          q4 = scholasticData[getColumnIndex('VR')];
          final = scholasticData[getColumnIndex('WN')];
        }
        break;
      case 22: // General Average
        q1 = scholasticData[getColumnIndex('TE')];
        q2 = scholasticData[getColumnIndex('UA')];
        q3 = scholasticData[getColumnIndex('UW')];
        q4 = scholasticData[getColumnIndex('VS')];
        final = scholasticData[getColumnIndex('WO')];
        break;
    }

    // Sanitize all values
  q1 = sanitizeValue(q1);
  q2 = sanitizeValue(q2);
  q3 = sanitizeValue(q3);
  q4 = sanitizeValue(q4);
  final = sanitizeValue(final);

  // Determine remarks (column 7)
  if (final === "") {
    remarks = "";
  } else

    // Determine remarks
    if (rowNumber === 22) {
      if (final === "") {
        remarks = "";
      } else {
        const failedCount = [7, 8, 9, 10, 11, 12, 13, 14, 18].reduce((count, row) => {
          const rowFinal = getGradeDataBox5(row, gradeValue, schoolYearValue, scholasticData).final;
          return count + (rowFinal !== "" && parseFloat(rowFinal) < 75 ? 1 : 0);
        }, 0);

        if (failedCount > 2) {
          remarks = "RETAINED";
        } else if (failedCount === 0) {
          remarks = "PROMOTED";
        } else {
          remarks = "REMEDIAL";
        }
      }
    } else {
      remarks = final === "" ? "" : (parseFloat(final) < 75 ? "FAILED" : "PASSED");
    }

    console.log(`Retrieved values for row ${rowNumber}: q1=${q1}, q2=${q2}, q3=${q3}, q4=${q4}, final=${final}, remarks=${remarks}`);

    return { q1, q2, q3, q4, final, remarks };
  } catch (error) {
    console.error(`Error in getGradeDataBox5 for row ${rowNumber}:`, error);
    return { q1: '', q2: '', q3: '', q4: '', final: '', remarks: '' };
  }
}

function getGradeDataBox6(rowNumber, gradeValue, schoolYearValue, scholasticData) {
  console.log(`getGradeDataBox6 input: rowNumber=${rowNumber}, gradeValue=${gradeValue}, schoolYearValue=${schoolYearValue}`);
  
  if (isEmpty(gradeValue) || isEmpty(schoolYearValue)) {
    console.log("Box 6: Empty grade or school year value detected. Returning empty result.");
    return { q1: '', q2: '', q3: '', q4: '', final: '', remarks: '' };
  }

  const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
  const grade = parseInt(gradeValue, 10);
  const sanitizeValue = (value) => (value === undefined || value === null || value === '') ? '' : value;


  let q1 = '', q2 = '', q3 = '', q4 = '', final = '', remarks = '';

  function getColumnIndex(letter) {
    let index = 0;
    for (let i = 0; i < letter.length; i++) {
      index = index * 26 + letter.charCodeAt(i) - 64;
    }
    return index - 1;
  }

    switch (rowNumber) {
      case 7: // Mother Tongue
        if (grade === 1 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('XU')];
          q2 = scholasticData[getColumnIndex('YQ')];
          q3 = scholasticData[getColumnIndex('ZM')];
          q4 = scholasticData[getColumnIndex('AAI')];
          final = scholasticData[getColumnIndex('ABE')];
        } else if (grade > 1 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('XG')];
          q2 = scholasticData[getColumnIndex('YC')];
          q3 = scholasticData[getColumnIndex('YY')];
          q4 = scholasticData[getColumnIndex('ZU')];
          final = scholasticData[getColumnIndex('AAQ')];
        } else {
          q1 = scholasticData[getColumnIndex('XF')];
          q2 = scholasticData[getColumnIndex('YB')];
          q3 = scholasticData[getColumnIndex('YX')];
          q4 = scholasticData[getColumnIndex('ZT')];
          final = scholasticData[getColumnIndex('AAP')];
        }
        break;
      case 8: // Filipino
        if (grade === 1 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('XV')];
          q2 = scholasticData[getColumnIndex('YR')];
          q3 = scholasticData[getColumnIndex('ZN')];
          q4 = scholasticData[getColumnIndex('AAJ')];
          final = scholasticData[getColumnIndex('ABF')];
        } else if (grade > 1 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('XH')];
          q2 = scholasticData[getColumnIndex('YD')];
          q3 = scholasticData[getColumnIndex('YZ')];
          q4 = scholasticData[getColumnIndex('ZV')];
          final = scholasticData[getColumnIndex('AAR')];
        } else {
          q1 = scholasticData[getColumnIndex('XG')];
          q2 = scholasticData[getColumnIndex('YC')];
          q3 = scholasticData[getColumnIndex('YY')];
          q4 = scholasticData[getColumnIndex('ZU')];
          final = scholasticData[getColumnIndex('AAQ')];
        }
        break;
      case 9: // English
        if (grade < 7 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('XI')];
          q2 = scholasticData[getColumnIndex('YE')];
          q3 = scholasticData[getColumnIndex('ZA')];
          q4 = scholasticData[getColumnIndex('ZW')];
          final = scholasticData[getColumnIndex('AAS')];
        } else {
          q1 = scholasticData[getColumnIndex('XH')];
          q2 = scholasticData[getColumnIndex('YD')];
          q3 = scholasticData[getColumnIndex('YZ')];
          q4 = scholasticData[getColumnIndex('ZV')];
          final = scholasticData[getColumnIndex('AAR')];
        }
        break;
      case 10: // Mathematics
        if (schoolYearStart > 2023) {
          if (grade < 4) {
            q1 = scholasticData[getColumnIndex('XE')];
            q2 = scholasticData[getColumnIndex('YA')];
            q3 = scholasticData[getColumnIndex('YW')];
            q4 = scholasticData[getColumnIndex('ZS')];
            final = scholasticData[getColumnIndex('AAO')];
          } else if (grade >= 4) {
            q1 = scholasticData[getColumnIndex('XK')];
            q2 = scholasticData[getColumnIndex('YG')];
            q3 = scholasticData[getColumnIndex('ZC')];
            q4 = scholasticData[getColumnIndex('ZY')];
            final = scholasticData[getColumnIndex('AAU')];
          }
        } else {
          q1 = scholasticData[getColumnIndex('XI')];
          q2 = scholasticData[getColumnIndex('YE')];
          q3 = scholasticData[getColumnIndex('ZA')];
          q4 = scholasticData[getColumnIndex('ZW')];
          final = scholasticData[getColumnIndex('AAS')];
        }
        break;
      case 11: // Science
        if (grade < 7 && schoolYearStart > 2023) {
          q1 = scholasticData[getColumnIndex('XD')];
          q2 = scholasticData[getColumnIndex('XZ')];
          q3 = scholasticData[getColumnIndex('YV')];
          q4 = scholasticData[getColumnIndex('ZR')];
          final = scholasticData[getColumnIndex('AAN')];
        } else {
          q1 = scholasticData[getColumnIndex('XJ')];
          q2 = scholasticData[getColumnIndex('YF')];
          q3 = scholasticData[getColumnIndex('ZB')];
          q4 = scholasticData[getColumnIndex('ZX')];
          final = scholasticData[getColumnIndex('AAT')];
        }
        break;
      case 12: // Araling Panlipunan (AP)
        if (grade < 3 && schoolYearStart > 2023) {
          // Empty string for grades 1-2 after 2023
        } else if (schoolYearStart > 2023 && grade < 7) {
          q1 = scholasticData[getColumnIndex('XJ')];
          q2 = scholasticData[getColumnIndex('YF')];
          q3 = scholasticData[getColumnIndex('ZB')];
          q4 = scholasticData[getColumnIndex('ZX')];
          final = scholasticData[getColumnIndex('AAT')];
        } else {
          q1 = scholasticData[getColumnIndex('XK')];
          q2 = scholasticData[getColumnIndex('YG')];
          q3 = scholasticData[getColumnIndex('ZC')];
          q4 = scholasticData[getColumnIndex('ZY')];
          final = scholasticData[getColumnIndex('AAU')];
        }
        break;
      case 13: // EPP/TLE
        if (schoolYearStart > 2023 && grade < 4) {
          // Empty string for grades 1-3 after 2023
        } else {
          q1 = scholasticData[getColumnIndex('XL')];
          q2 = scholasticData[getColumnIndex('YH')];
          q3 = scholasticData[getColumnIndex('ZD')];
          q4 = scholasticData[getColumnIndex('ZZ')];
          final = scholasticData[getColumnIndex('AAV')];
        }
        break;
      case 14: // MAPEH
        if (schoolYearStart > 2023 && grade < 4) {
          // Empty string for grades 1-3 after 2023
        } else {
          q1 = scholasticData[getColumnIndex('XS')];
          q2 = scholasticData[getColumnIndex('YO')];
          q3 = scholasticData[getColumnIndex('ZK')];
          q4 = scholasticData[getColumnIndex('AAG')];
          final = scholasticData[getColumnIndex('ABC')];
        }
        break;
      case 15: // Music
        if (schoolYearStart > 2023) {
          if (grade < 4) {
            // Empty string for grades 1-3 after 2023
          } else if (grade >= 4) {
            q1 = scholasticData[getColumnIndex('XQ')];
            q2 = scholasticData[getColumnIndex('YM')];
            q3 = scholasticData[getColumnIndex('ZI')];
            q4 = scholasticData[getColumnIndex('AAE')];
            final = scholasticData[getColumnIndex('ABA')];
          }
        } else {
          q1 = scholasticData[getColumnIndex('XM')];
          q2 = scholasticData[getColumnIndex('YI')];
          q3 = scholasticData[getColumnIndex('ZE')];
          q4 = scholasticData[getColumnIndex('AAA')];
          final = scholasticData[getColumnIndex('AAW')];
        }
        break;
      case 16: // Arts
        if (schoolYearStart > 2023) {
          if (grade < 4) {
            // Empty string for grades 1-3 after 2023
          } else if (grade >= 4) {
            q1 = scholasticData[getColumnIndex('XR')];
            q2 = scholasticData[getColumnIndex('YN')];
            q3 = scholasticData[getColumnIndex('ZJ')];
            q4 = scholasticData[getColumnIndex('AAF')];
            final = scholasticData[getColumnIndex('ABB')];
          }
        } else {
          q1 = scholasticData[getColumnIndex('XN')];
          q2 = scholasticData[getColumnIndex('YJ')];
          q3 = scholasticData[getColumnIndex('ZF')];
          q4 = scholasticData[getColumnIndex('AAB')];
          final = scholasticData[getColumnIndex('AAX')];
        }
        break;
      case 17: // Physical Education
        if (schoolYearStart > 2023 && grade < 7) {
          // Empty string for grades 1-6 after 2023
        } else {
          q1 = scholasticData[getColumnIndex('XO')];
          q2 = scholasticData[getColumnIndex('YK')];
          q3 = scholasticData[getColumnIndex('ZG')];
          q4 = scholasticData[getColumnIndex('AAC')];
          final = scholasticData[getColumnIndex('AAY')];
        }
        break;
      case 18: // Health
        if (schoolYearStart > 2023 && grade < 7) {
          // Empty string for grades 1-6 after 2023
        } else {
          q1 = scholasticData[getColumnIndex('XP')];
          q2 = scholasticData[getColumnIndex('YL')];
          q3 = scholasticData[getColumnIndex('ZH')];
          q4 = scholasticData[getColumnIndex('AAD')];
          final = scholasticData[getColumnIndex('AAZ')];
        }
        break;
      case 19: // Edukasyon sa Pagpapakatao
        if (schoolYearStart > 2023 && grade < 7) {
          // Empty string for grades 1-6 after 2023
        } else {
          q1 = scholasticData[getColumnIndex('XT')];
          q2 = scholasticData[getColumnIndex('YP')];
          q3 = scholasticData[getColumnIndex('ZL')];
          q4 = scholasticData[getColumnIndex('AAH')];
          final = scholasticData[getColumnIndex('ABD')];
        }
        break;
      case 20: // Arabic Language / Islamic Values
        if (getSubjectText(20, gradeValue, schoolYearValue).includes("Arabic Language")) {
          q1 = scholasticData[getColumnIndex('XW')];
          q2 = scholasticData[getColumnIndex('YS')];
          q3 = scholasticData[getColumnIndex('ZO')];
          q4 = scholasticData[getColumnIndex('AAK')];
          final = scholasticData[getColumnIndex('ABG')];
        } else if (getSubjectText(20, gradeValue, schoolYearValue).includes("Islamic Values Education")) {
          q1 = scholasticData[getColumnIndex('XX')];
          q2 = scholasticData[getColumnIndex('YT')];
          q3 = scholasticData[getColumnIndex('ZP')];
          q4 = scholasticData[getColumnIndex('AAL')];
          final = scholasticData[getColumnIndex('ABH')];
        }
        break;
      case 22: // General Average
        q1 = scholasticData[getColumnIndex('XY')];
        q2 = scholasticData[getColumnIndex('YU')];
        q3 = scholasticData[getColumnIndex('ZQ')];
        q4 = scholasticData[getColumnIndex('AAM')];
        final = scholasticData[getColumnIndex('ABI')];
        break;
    }

    // Sanitize all values
  q1 = sanitizeValue(q1);
  q2 = sanitizeValue(q2);
  q3 = sanitizeValue(q3);
  q4 = sanitizeValue(q4);
  final = sanitizeValue(final);

  // Determine remarks (column 7)
  if (final === "") {
    remarks = "";
  } else
  if (rowNumber === 22) {
    if (final === "") {
      remarks = "";
    } else {
      const failedCount = [7, 8, 9, 10, 11, 12, 13, 14, 18].reduce((count, row) => {
        const rowFinal = getGradeDataBox6(row, gradeValue, schoolYearValue, scholasticData).final;
        return count + (rowFinal !== "" && parseFloat(rowFinal) < 75 ? 1 : 0);
      }, 0);

      if (failedCount > 2) {
        remarks = "RETAINED";
      } else if (failedCount === 0) {
        remarks = "PROMOTED";
      } else {
        remarks = "REMEDIAL";
      }
    }
  } else {
    remarks = final === "" ? "" : (parseFloat(final) < 75 ? "FAILED" : "PASSED");
  }

  console.log(`Retrieved values for row ${rowNumber}: q1=${q1}, q2=${q2}, q3=${q3}, q4=${q4}, final=${final}, remarks=${remarks}`);

  return { q1, q2, q3, q4, final, remarks };
}

function getGradeDataBox7(rowNumber, gradeValue, schoolYearValue, scholasticData) {
  console.log(`getGradeDataBox7 input: rowNumber=${rowNumber}, gradeValue=${gradeValue}, schoolYearValue=${schoolYearValue}`);
  
  if (isEmpty(gradeValue) || isEmpty(schoolYearValue)) {
    console.log("Box 7: Empty grade or school year value detected. Returning empty result.");
    return { q1: '', q2: '', q3: '', q4: '', final: '', remarks: '' };
  }

  const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
  const grade = parseInt(gradeValue, 10);
  const sanitizeValue = (value) => (value === undefined || value === null || value === '') ? '' : value;


  let q1 = '', q2 = '', q3 = '', q4 = '', final = '', remarks = '';

  function getColumnIndex(letter) {
    let index = 0;
    for (let i = 0; i < letter.length; i++) {
      index = index * 26 + letter.charCodeAt(i) - 64;
    }
    return index - 1;
  }

  switch (rowNumber) {
    case 7: // Mother Tongue
      if (grade === 1 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('ACO')];
        q2 = scholasticData[getColumnIndex('ADK')];
        q3 = scholasticData[getColumnIndex('AEG')];
        q4 = scholasticData[getColumnIndex('AFC')];
        final = scholasticData[getColumnIndex('AFY')];
      } else if (grade > 1 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('ACA')];
        q2 = scholasticData[getColumnIndex('ACW')];
        q3 = scholasticData[getColumnIndex('ADS')];
        q4 = scholasticData[getColumnIndex('AEO')];
        final = scholasticData[getColumnIndex('AFK')];
      } else {
        q1 = scholasticData[getColumnIndex('ABZ')];
        q2 = scholasticData[getColumnIndex('ACV')];
        q3 = scholasticData[getColumnIndex('ADR')];
        q4 = scholasticData[getColumnIndex('AEN')];
        final = scholasticData[getColumnIndex('AFJ')];
      }
      break;
    case 8: // Filipino
      if (grade === 1 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('ACP')];
        q2 = scholasticData[getColumnIndex('ADL')];
        q3 = scholasticData[getColumnIndex('AEH')];
        q4 = scholasticData[getColumnIndex('AFD')];
        final = scholasticData[getColumnIndex('AFZ')];
      } else if (grade > 1 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('ACB')];
        q2 = scholasticData[getColumnIndex('ACX')];
        q3 = scholasticData[getColumnIndex('ADT')];
        q4 = scholasticData[getColumnIndex('AEP')];
        final = scholasticData[getColumnIndex('AFL')];
      } else {
        q1 = scholasticData[getColumnIndex('ACA')];
        q2 = scholasticData[getColumnIndex('ACW')];
        q3 = scholasticData[getColumnIndex('ADS')];
        q4 = scholasticData[getColumnIndex('AEO')];
        final = scholasticData[getColumnIndex('AFK')];
      }
      break;
    case 9: // English
      if (grade < 7 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('ACC')];
        q2 = scholasticData[getColumnIndex('ACY')];
        q3 = scholasticData[getColumnIndex('ADU')];
        q4 = scholasticData[getColumnIndex('AEQ')];
        final = scholasticData[getColumnIndex('AFM')];
      } else {
        q1 = scholasticData[getColumnIndex('ACB')];
        q2 = scholasticData[getColumnIndex('ACX')];
        q3 = scholasticData[getColumnIndex('ADT')];
        q4 = scholasticData[getColumnIndex('AEP')];
        final = scholasticData[getColumnIndex('AFL')];
      }
      break;
    case 10: // Mathematics
      if (schoolYearStart > 2023) {
        if (grade < 4) {
          q1 = scholasticData[getColumnIndex('ABY')];
          q2 = scholasticData[getColumnIndex('ACU')];
          q3 = scholasticData[getColumnIndex('ADQ')];
          q4 = scholasticData[getColumnIndex('AEM')];
          final = scholasticData[getColumnIndex('AFI')];
        } else if (grade >= 4) {
          q1 = scholasticData[getColumnIndex('ACE')];
          q2 = scholasticData[getColumnIndex('ADA')];
          q3 = scholasticData[getColumnIndex('ADW')];
          q4 = scholasticData[getColumnIndex('AES')];
          final = scholasticData[getColumnIndex('AFO')];
        }
      } else {
        q1 = scholasticData[getColumnIndex('ACC')];
        q2 = scholasticData[getColumnIndex('ACY')];
        q3 = scholasticData[getColumnIndex('ADU')];
        q4 = scholasticData[getColumnIndex('AEQ')];
        final = scholasticData[getColumnIndex('AFM')];
      }
      break;
    case 11: // Science
      if (grade < 7 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('ABX')];
        q2 = scholasticData[getColumnIndex('ACT')];
        q3 = scholasticData[getColumnIndex('ADP')];
        q4 = scholasticData[getColumnIndex('AEL')];
        final = scholasticData[getColumnIndex('AFH')];
      } else {
        q1 = scholasticData[getColumnIndex('ACD')];
        q2 = scholasticData[getColumnIndex('ACZ')];
        q3 = scholasticData[getColumnIndex('ADV')];
        q4 = scholasticData[getColumnIndex('AER')];
        final = scholasticData[getColumnIndex('AFN')];
      }
      break;
    case 12: // Araling Panlipunan (AP)
      if (grade < 3 && schoolYearStart > 2023) {
        q1 = q2 = q3 = q4 = final = "";
      } else if (schoolYearStart > 2023 && grade < 7) {
        q1 = scholasticData[getColumnIndex('ACD')];
        q2 = scholasticData[getColumnIndex('ACZ')];
        q3 = scholasticData[getColumnIndex('ADV')];
        q4 = scholasticData[getColumnIndex('AER')];
        final = scholasticData[getColumnIndex('AFN')];
      } else {
        q1 = scholasticData[getColumnIndex('ACE')];
        q2 = scholasticData[getColumnIndex('ADA')];
        q3 = scholasticData[getColumnIndex('ADW')];
        q4 = scholasticData[getColumnIndex('AES')];
        final = scholasticData[getColumnIndex('AFO')];
      }
      break;
    case 13: // Edukasyon sa Pagpapakatao (EsP)
      if (schoolYearStart > 2023 && grade < 4) {
        q1 = q2 = q3 = q4 = final = "";
      } else {
        q1 = scholasticData[getColumnIndex('ACF')];
        q2 = scholasticData[getColumnIndex('ADB')];
        q3 = scholasticData[getColumnIndex('ADX')];
        q4 = scholasticData[getColumnIndex('AET')];
        final = scholasticData[getColumnIndex('AFP')];
      }
      break;
    case 14: // Music
      if (schoolYearStart > 2023 && grade < 4) {
        q1 = q2 = q3 = q4 = final = "";
      } else {
        q1 = scholasticData[getColumnIndex('ACM')];
        q2 = scholasticData[getColumnIndex('ADI')];
        q3 = scholasticData[getColumnIndex('AEE')];
        q4 = scholasticData[getColumnIndex('AFA')];
        final = scholasticData[getColumnIndex('AFW')];
      }
      break;
    case 15: // Arts
      if (schoolYearStart > 2023) {
        if (grade < 4) {
          q1 = q2 = q3 = q4 = final = "";
        } else if (grade >= 4) {
          q1 = scholasticData[getColumnIndex('ACK')];
          q2 = scholasticData[getColumnIndex('ADG')];
          q3 = scholasticData[getColumnIndex('AEC')];
          q4 = scholasticData[getColumnIndex('AEY')];
          final = scholasticData[getColumnIndex('AFU')];
        }
      } else {
        q1 = scholasticData[getColumnIndex('ACG')];
        q2 = scholasticData[getColumnIndex('ADC')];
        q3 = scholasticData[getColumnIndex('ADY')];
        q4 = scholasticData[getColumnIndex('AEU')];
        final = scholasticData[getColumnIndex('AFQ')];
      }
      break;
    case 16: // Physical Education
      if (schoolYearStart > 2023) {
        if (grade < 4) {
          q1 = q2 = q3 = q4 = final = "";
        } else if (grade >= 4) {
          q1 = scholasticData[getColumnIndex('ACL')];
          q2 = scholasticData[getColumnIndex('ADH')];
          q3 = scholasticData[getColumnIndex('AED')];
          q4 = scholasticData[getColumnIndex('AEZ')];
          final = scholasticData[getColumnIndex('AFV')];
        }
      } else {
        q1 = scholasticData[getColumnIndex('ACH')];
        q2 = scholasticData[getColumnIndex('ADD')];
        q3 = scholasticData[getColumnIndex('ADZ')];
        q4 = scholasticData[getColumnIndex('AEV')];
        final = scholasticData[getColumnIndex('AFR')];
      }
      break;
    case 17: // Health
      if (schoolYearStart > 2023 && grade < 7) {
        q1 = q2 = q3 = q4 = final = "";
      } else {
        q1 = scholasticData[getColumnIndex('ACI')];
        q2 = scholasticData[getColumnIndex('ADE')];
        q3 = scholasticData[getColumnIndex('AEA')];
        q4 = scholasticData[getColumnIndex('AEW')];
        final = scholasticData[getColumnIndex('AFS')];
      }
      break;
    case 18: // Edukasyong Pantahanan at Pangkabuhayan (EPP) / Technology and Livelihood Education (TLE)
      if (schoolYearStart > 2023 && grade < 7) {
        q1 = q2 = q3 = q4 = final = "";
      } else {
        q1 = scholasticData[getColumnIndex('ACJ')];
        q2 = scholasticData[getColumnIndex('ADF')];
        q3 = scholasticData[getColumnIndex('AEB')];
        q4 = scholasticData[getColumnIndex('AEX')];
        final = scholasticData[getColumnIndex('AFT')];
      }
      break;
    case 19: // Edukasyon sa Pagpapakatao
      if (schoolYearStart > 2023 && grade < 7) {
        q1 = q2 = q3 = q4 = final = "";
      } else {
        q1 = scholasticData[getColumnIndex('ACN')];
        q2 = scholasticData[getColumnIndex('ADJ')];
        q3 = scholasticData[getColumnIndex('AEF')];
        q4 = scholasticData[getColumnIndex('AFB')];
        final = scholasticData[getColumnIndex('AFX')];
      }
      break;
    
      case 20:
      {
        const subjectText = getSubjectText(20, gradeValue, schoolYearValue);
        if (subjectText.includes("Arabic Language")) {
          q1 = scholasticData[getColumnIndex('ACQ')];
          q2 = scholasticData[getColumnIndex('ADM')];
          q3 = scholasticData[getColumnIndex('AEI')];
          q4 = scholasticData[getColumnIndex('AFE')];
          final = scholasticData[getColumnIndex('AGA')];
        }
      }
      break;
    case 21:
      {
        const subjectText = getSubjectText(21, gradeValue, schoolYearValue);
        if (subjectText.includes("Islamic Values Education")) {
          q1 = scholasticData[getColumnIndex('ACR')];
          q2 = scholasticData[getColumnIndex('ADN')];
          q3 = scholasticData[getColumnIndex('AEJ')];
          q4 = scholasticData[getColumnIndex('AFF')];
          final = scholasticData[getColumnIndex('AGB')];
        }
      }
      break;
    case 22:
      {
        const subjectText = getSubjectText(22, gradeValue, schoolYearValue);
        if (subjectText.includes("General Average")) {
          q1 = scholasticData[getColumnIndex('ACS')];
          q2 = scholasticData[getColumnIndex('ADO')];
          q3 = scholasticData[getColumnIndex('AEK')];
          q4 = scholasticData[getColumnIndex('AFG')];
          final = scholasticData[getColumnIndex('AGC')];
        }
      }
      break;
  }

  // Sanitize all values
  q1 = sanitizeValue(q1);
  q2 = sanitizeValue(q2);
  q3 = sanitizeValue(q3);
  q4 = sanitizeValue(q4);
  final = sanitizeValue(final);

  // Determine remarks (column 7)
  if (final === "") {
    remarks = "";
  } else
  if (rowNumber === 22) {
    if (final === "") {
      remarks = "";
    } else {
      const failedCount = [7, 8, 9, 10, 11, 12, 13, 14, 18].reduce((count, row) => {
        const rowFinal = getGradeDataBox7(row, gradeValue, schoolYearValue, scholasticData).final;
        return count + (rowFinal !== "" && parseFloat(rowFinal) < 75 ? 1 : 0);
      }, 0);

      if (failedCount > 2) {
        remarks = "RETAINED";
      } else if (failedCount === 0) {
        remarks = "PROMOTED";
      } else {
        remarks = "REMEDIAL";
      }
    }
  } else {
    remarks = final === "" ? "" : (parseFloat(final) < 75 ? "FAILED" : "PASSED");
  }

  console.log(`Retrieved values for row ${rowNumber}: q1=${q1}, q2=${q2}, q3=${q3}, q4=${q4}, final=${final}, remarks=${remarks}`);

  return { q1, q2, q3, q4, final, remarks };
}

function getGradeDataBox8(rowNumber, gradeValue, schoolYearValue, scholasticData) {
  console.log(`getGradeDataBox8 input: rowNumber=${rowNumber}, gradeValue=${gradeValue}, schoolYearValue=${schoolYearValue}`);
  
  if (isEmpty(gradeValue) || isEmpty(schoolYearValue)) {
    console.log("Box 8: Empty grade or school year value detected. Returning empty result.");
    return { q1: '', q2: '', q3: '', q4: '', final: '', remarks: '' };
  }

  const schoolYearStart = parseInt(schoolYearValue.substring(0, 4), 10);
  const grade = parseInt(gradeValue, 10);
  const sanitizeValue = (value) => (value === undefined || value === null || value === '') ? '' : value;


  let q1 = '', q2 = '', q3 = '', q4 = '', final = '', remarks = '';

  function getColumnIndex(letter) {
    let index = 0;
    for (let i = 0; i < letter.length; i++) {
      index = index * 26 + letter.charCodeAt(i) - 64;
    }
    return index - 1;
  }

  switch (rowNumber) {
    case 7:
      if (grade === 1 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('AHI')];
        q2 = scholasticData[getColumnIndex('AIE')];
        q3 = scholasticData[getColumnIndex('AJA')];
        q4 = scholasticData[getColumnIndex('AJW')];
        final = scholasticData[getColumnIndex('AKS')];
      } else if (grade > 1 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('AGU')];
        q2 = scholasticData[getColumnIndex('AHQ')];
        q3 = scholasticData[getColumnIndex('AIM')];
        q4 = scholasticData[getColumnIndex('AJI')];
        final = scholasticData[getColumnIndex('AKE')];
      } else {
        q1 = scholasticData[getColumnIndex('AGT')];
        q2 = scholasticData[getColumnIndex('AHP')];
        q3 = scholasticData[getColumnIndex('AIL')];
        q4 = scholasticData[getColumnIndex('AJH')];
        final = scholasticData[getColumnIndex('AKD')];
      }
      break;
    case 8:
      if (grade === 1 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('AHJ')];
        q2 = scholasticData[getColumnIndex('AIF')];
        q3 = scholasticData[getColumnIndex('AJB')];
        q4 = scholasticData[getColumnIndex('AJX')];
        final = scholasticData[getColumnIndex('AKT')];
      } else if (grade > 1 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('AGV')];
        q2 = scholasticData[getColumnIndex('AHR')];
        q3 = scholasticData[getColumnIndex('AIN')];
        q4 = scholasticData[getColumnIndex('AJJ')];
        final = scholasticData[getColumnIndex('AKF')];
      } else {
        q1 = scholasticData[getColumnIndex('AGU')];
        q2 = scholasticData[getColumnIndex('AHQ')];
        q3 = scholasticData[getColumnIndex('AIM')];
        q4 = scholasticData[getColumnIndex('AJI')];
        final = scholasticData[getColumnIndex('AKE')];
      }
      break;
      case 9:
      if (grade < 7 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('AGW')];
        q2 = scholasticData[getColumnIndex('AHS')];
        q3 = scholasticData[getColumnIndex('AIO')];
        q4 = scholasticData[getColumnIndex('AJK')];
        final = scholasticData[getColumnIndex('AKG')];
      } else {
        q1 = scholasticData[getColumnIndex('AGV')];
        q2 = scholasticData[getColumnIndex('AHR')];
        q3 = scholasticData[getColumnIndex('AIN')];
        q4 = scholasticData[getColumnIndex('AJJ')];
        final = scholasticData[getColumnIndex('AKF')];
      }
      break;
    case 10:
      if (schoolYearStart > 2023) {
        if (grade < 4) {
          q1 = scholasticData[getColumnIndex('AGS')];
          q2 = scholasticData[getColumnIndex('AHO')];
          q3 = scholasticData[getColumnIndex('AIK')];
          q4 = scholasticData[getColumnIndex('AJG')];
          final = scholasticData[getColumnIndex('AKC')];
        } else if (grade >= 4) {
          q1 = scholasticData[getColumnIndex('AGY')];
          q2 = scholasticData[getColumnIndex('AHU')];
          q3 = scholasticData[getColumnIndex('AIQ')];
          q4 = scholasticData[getColumnIndex('AJM')];
          final = scholasticData[getColumnIndex('AKI')];
        }
      } else {
        q1 = scholasticData[getColumnIndex('AGW')];
        q2 = scholasticData[getColumnIndex('AHS')];
        q3 = scholasticData[getColumnIndex('AIO')];
        q4 = scholasticData[getColumnIndex('AJK')];
        final = scholasticData[getColumnIndex('AKG')];
      }
      break;
    case 11:
      if (grade < 7 && schoolYearStart > 2023) {
        q1 = scholasticData[getColumnIndex('AGR')];
        q2 = scholasticData[getColumnIndex('AHN')];
        q3 = scholasticData[getColumnIndex('AIJ')];
        q4 = scholasticData[getColumnIndex('AJF')];
        final = scholasticData[getColumnIndex('AKB')];
      } else {
        q1 = scholasticData[getColumnIndex('AGX')];
        q2 = scholasticData[getColumnIndex('AHT')];
        q3 = scholasticData[getColumnIndex('AIP')];
        q4 = scholasticData[getColumnIndex('AJL')];
        final = scholasticData[getColumnIndex('AKH')];
      }
      break;
    case 12:
      if (grade < 3 && schoolYearStart > 2023) {
        // Empty string for grades 1-2 after 2023
      } else if (schoolYearStart > 2023 && grade < 7) {
        q1 = scholasticData[getColumnIndex('AGX')];
        q2 = scholasticData[getColumnIndex('AHT')];
        q3 = scholasticData[getColumnIndex('AIP')];
        q4 = scholasticData[getColumnIndex('AJL')];
        final = scholasticData[getColumnIndex('AKH')];
      } else {
        q1 = scholasticData[getColumnIndex('AGY')];
        q2 = scholasticData[getColumnIndex('AHU')];
        q3 = scholasticData[getColumnIndex('AIQ')];
        q4 = scholasticData[getColumnIndex('AJM')];
        final = scholasticData[getColumnIndex('AKI')];
      }
      break;
    case 13:
      if (schoolYearStart > 2023 && grade < 4) {
        // Empty string for grades 1-3 after 2023
      } else {
        q1 = scholasticData[getColumnIndex('AGZ')];
        q2 = scholasticData[getColumnIndex('AHV')];
        q3 = scholasticData[getColumnIndex('AIR')];
        q4 = scholasticData[getColumnIndex('AJN')];
        final = scholasticData[getColumnIndex('AKJ')];
      }
      break;
    case 14:
      if (schoolYearStart > 2023 && grade < 4) {
        // Empty string for grades 1-3 after 2023
      } else {
        q1 = scholasticData[getColumnIndex('AHG')];
        q2 = scholasticData[getColumnIndex('AIC')];
        q3 = scholasticData[getColumnIndex('AIY')];
        q4 = scholasticData[getColumnIndex('AJU')];
        final = scholasticData[getColumnIndex('AKQ')];
      }
      break;
    case 15:
      if (schoolYearStart > 2023) {
        if (grade < 4) {
          // Empty string for grades 1-3 after 2023
        } else if (grade >= 4) {
          q1 = scholasticData[getColumnIndex('AHE')];
          q2 = scholasticData[getColumnIndex('AIA')];
          q3 = scholasticData[getColumnIndex('AIW')];
          q4 = scholasticData[getColumnIndex('AJS')];
          final = scholasticData[getColumnIndex('AKO')];
        }
      } else {
        q1 = scholasticData[getColumnIndex('AHA')];
        q2 = scholasticData[getColumnIndex('AHW')];
        q3 = scholasticData[getColumnIndex('AIS')];
        q4 = scholasticData[getColumnIndex('AJO')];
        final = scholasticData[getColumnIndex('AKK')];
      }
      break;
    case 16:
      if (schoolYearStart > 2023) {
        if (grade < 4) {
          // Empty string for grades 1-3 after 2023
        } else if (grade >= 4) {
          q1 = scholasticData[getColumnIndex('AHF')];
          q2 = scholasticData[getColumnIndex('AIB')];
          q3 = scholasticData[getColumnIndex('AIX')];
          q4 = scholasticData[getColumnIndex('AJT')];
          final = scholasticData[getColumnIndex('AKP')];
        }
      } else {
        q1 = scholasticData[getColumnIndex('AHB')];
        q2 = scholasticData[getColumnIndex('AHX')];
        q3 = scholasticData[getColumnIndex('AIT')];
        q4 = scholasticData[getColumnIndex('AJP')];
        final = scholasticData[getColumnIndex('AKL')];
      }
      break;
    case 17:
      if (schoolYearStart > 2023 && grade < 7) {
        // Empty string for grades 1-6 after 2023
      } else {
        q1 = scholasticData[getColumnIndex('AHC')];
        q2 = scholasticData[getColumnIndex('AHY')];
        q3 = scholasticData[getColumnIndex('AIU')];
        q4 = scholasticData[getColumnIndex('AJQ')];
        final = scholasticData[getColumnIndex('AKM')];
      }
      break;
    case 18:
      if (schoolYearStart > 2023 && grade < 7) {
        // Empty string for grades 1-6 after 2023
      } else {
        q1 = scholasticData[getColumnIndex('AHD')];
        q2 = scholasticData[getColumnIndex('AHZ')];
        q3 = scholasticData[getColumnIndex('AIV')];
        q4 = scholasticData[getColumnIndex('AJR')];
        final = scholasticData[getColumnIndex('AKN')];
      }
      break;
    case 19:
      if (schoolYearStart > 2023 && grade < 7) {
        // Empty string for grades 1-6 after 2023
      } else {
        q1 = scholasticData[getColumnIndex('AHH')];
        q2 = scholasticData[getColumnIndex('AID')];
        q3 = scholasticData[getColumnIndex('AIZ')];
        q4 = scholasticData[getColumnIndex('AJV')];
        final = scholasticData[getColumnIndex('AKR')];
      }
      break;
    case 20:
      {
        const subjectText = getSubjectText(20, gradeValue, schoolYearValue);
        if (subjectText.includes("Arabic Language")) {
          q1 = scholasticData[getColumnIndex('AHK')];
          q2 = scholasticData[getColumnIndex('AIG')];
          q3 = scholasticData[getColumnIndex('AJC')];
          q4 = scholasticData[getColumnIndex('AJY')];
          final = scholasticData[getColumnIndex('AKU')];
        }
      }
      break;
    case 21:
      {
        const subjectText = getSubjectText(21, gradeValue, schoolYearValue);
        if (subjectText.includes("Islamic Values Education")) {
          q1 = scholasticData[getColumnIndex('AHL')];
          q2 = scholasticData[getColumnIndex('AIH')];
          q3 = scholasticData[getColumnIndex('AJD')];
          q4 = scholasticData[getColumnIndex('AJZ')];
          final = scholasticData[getColumnIndex('AKV')];
        }
      }
      break;
    case 22:
      {
        const subjectText = getSubjectText(22, gradeValue, schoolYearValue);
        if (subjectText.includes("General Average")) {
          q1 = scholasticData[getColumnIndex('AHM')];
          q2 = scholasticData[getColumnIndex('AII')];
          q3 = scholasticData[getColumnIndex('AJE')];
          q4 = scholasticData[getColumnIndex('AKA')];
          final = scholasticData[getColumnIndex('AKW')];
        }
      }
      break;
  }

  // Sanitize all values
  q1 = sanitizeValue(q1);
  q2 = sanitizeValue(q2);
  q3 = sanitizeValue(q3);
  q4 = sanitizeValue(q4);
  final = sanitizeValue(final);

  // Determine remarks (column 7)
  if (final === "") {
    remarks = "";
  } else
  if (rowNumber === 22) {
    if (final === "") {
      remarks = "";
    } else {
      const failedCount = [7, 8, 9, 10, 11, 12, 13, 14, 18].reduce((count, row) => {
        const rowFinal = getGradeDataBox8(row, gradeValue, schoolYearValue, scholasticData).final;
        return count + (rowFinal !== "" && parseFloat(rowFinal) < 75 ? 1 : 0);
      }, 0);

      if (failedCount > 2) {
        remarks = "RETAINED";
      } else if (failedCount === 0) {
        remarks = "PROMOTED";
      } else {
        remarks = "REMEDIAL";
      }
    }
  } else {
    remarks = final === "" ? "" : (parseFloat(final) < 75 ? "FAILED" : "PASSED");
  }

  console.log(`Retrieved values for row ${rowNumber}: q1=${q1}, q2=${q2}, q3=${q3}, q4=${q4}, final=${final}, remarks=${remarks}`);

  return { q1, q2, q3, q4, final, remarks };
}
    
    
  

  </script>
</body>
</html>
